<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.66">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/favicon.ico"><title>消息队列 | 空山木巷</title><meta name="description" content="">
    <link rel="preload" href="/blog/assets/style-90eac310.css" as="style"><link rel="stylesheet" href="/blog/assets/style-90eac310.css">
    <link rel="modulepreload" href="/blog/assets/app-66d6b4fd.js"><link rel="modulepreload" href="/blog/assets/消息队列.html-a6146d9a.js"><link rel="modulepreload" href="/blog/assets/消息队列.html-b31ff32c.js"><link rel="prefetch" href="/blog/assets/index.html-33f7dfbb.js" as="script"><link rel="prefetch" href="/blog/assets/分布式事务.html-99ca016c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-67c923f9.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-c0e7ceff.js" as="script"><link rel="prefetch" href="/blog/assets/Redis缓存.html-988c20bf.js" as="script"><link rel="prefetch" href="/blog/assets/SaaS多租户.html-0b4298a2.js" as="script"><link rel="prefetch" href="/blog/assets/功能权限.html-1a5bbea9.js" as="script"><link rel="prefetch" href="/blog/assets/幂等性（防重复提交）.html-43a94299.js" as="script"><link rel="prefetch" href="/blog/assets/数据库 MyBatis.html-0283d0f0.js" as="script"><link rel="prefetch" href="/blog/assets/数据权限.html-06e84b51.js" as="script"><link rel="prefetch" href="/blog/assets/本地缓存.html-b0021a15.js" as="script"><link rel="prefetch" href="/blog/assets/用户认证.html-9edb96f7.js" as="script"><link rel="prefetch" href="/blog/assets/系统日志.html-6f65c9c7.js" as="script"><link rel="prefetch" href="/blog/assets/统一响应和异常处理（错误码）.html-48753ae0.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-4751f011.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-f3cba283.js" as="script"><link rel="prefetch" href="/blog/assets/1-MySQL常用的命令.html-ee92d52b.js" as="script"><link rel="prefetch" href="/blog/assets/13-责任链模式.html-ecb3744d.js" as="script"><link rel="prefetch" href="/blog/assets/14-命令模式.html-5eb58d88.js" as="script"><link rel="prefetch" href="/blog/assets/15-解析器模式.html-96606363.js" as="script"><link rel="prefetch" href="/blog/assets/16-迭代器模式.html-8ebf1e59.js" as="script"><link rel="prefetch" href="/blog/assets/17-中介者模式.html-a0f26b82.js" as="script"><link rel="prefetch" href="/blog/assets/18-备忘录模式.html-37ec7801.js" as="script"><link rel="prefetch" href="/blog/assets/19-观察者模式.html-68ace6a1.js" as="script"><link rel="prefetch" href="/blog/assets/20-状态模式.html-a5f78c82.js" as="script"><link rel="prefetch" href="/blog/assets/21-策略模式.html-a0ea40f7.js" as="script"><link rel="prefetch" href="/blog/assets/22-模板方法模式.html-f1f66b72.js" as="script"><link rel="prefetch" href="/blog/assets/23-访问者模式.html-cd09056c.js" as="script"><link rel="prefetch" href="/blog/assets/1-单例模式.html-5e97ccb1.js" as="script"><link rel="prefetch" href="/blog/assets/2-抽象工厂模式.html-2a70948c.js" as="script"><link rel="prefetch" href="/blog/assets/3-工厂方法模式.html-88c631dd.js" as="script"><link rel="prefetch" href="/blog/assets/4-建造者模式.html-210f3d70.js" as="script"><link rel="prefetch" href="/blog/assets/5-原型模式.html-e37c22fb.js" as="script"><link rel="prefetch" href="/blog/assets/10-桥接模式.html-bb899021.js" as="script"><link rel="prefetch" href="/blog/assets/11-组合模式.html-608f7edb.js" as="script"><link rel="prefetch" href="/blog/assets/12-享元模式.html-7eb14c96.js" as="script"><link rel="prefetch" href="/blog/assets/6-适配器模式.html-42ada3ad.js" as="script"><link rel="prefetch" href="/blog/assets/7-装饰器模式.html-8765fae1.js" as="script"><link rel="prefetch" href="/blog/assets/8-外观模式.html-0103ad00.js" as="script"><link rel="prefetch" href="/blog/assets/9-代理模式.html-72f08df8.js" as="script"><link rel="prefetch" href="/blog/assets/UML类图.html-56387884.js" as="script"><link rel="prefetch" href="/blog/assets/1-Java8新特性概述.html-adb6e16e.js" as="script"><link rel="prefetch" href="/blog/assets/10-Stream API的中间操作.html-dcbf3f12.js" as="script"><link rel="prefetch" href="/blog/assets/11-Stream API的终止操作.html-cc9d125f.js" as="script"><link rel="prefetch" href="/blog/assets/12-Optional类.html-c4d2ef31.js" as="script"><link rel="prefetch" href="/blog/assets/13-接口中的默认方法和静态方法.html-f470ea46.js" as="script"><link rel="prefetch" href="/blog/assets/14-新日期时间API.html-dcbed7d9.js" as="script"><link rel="prefetch" href="/blog/assets/15-重复注解与类型注解.html-f2f3eca7.js" as="script"><link rel="prefetch" href="/blog/assets/2-引入Lambda表达式.html-e6241b21.js" as="script"><link rel="prefetch" href="/blog/assets/3-Lambda表达式基础语法.html-26b78f6c.js" as="script"><link rel="prefetch" href="/blog/assets/4-Lambda表达式典型案例.html-0dca302e.js" as="script"><link rel="prefetch" href="/blog/assets/5-函数式接口.html-95fa5e28.js" as="script"><link rel="prefetch" href="/blog/assets/6-Java7和Java8的HashMap.html-1eb0c9da.js" as="script"><link rel="prefetch" href="/blog/assets/7-方法引用和构造器引用.html-f6d10b42.js" as="script"><link rel="prefetch" href="/blog/assets/8-Stream API基础.html-90d2d127.js" as="script"><link rel="prefetch" href="/blog/assets/9-Stream API的创建案例.html-1f13fad9.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ入门.html-c20c90f0.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ部署指南.html-6d5dea63.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ高级.html-713abb8b.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ简介.html-df81724a.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ部署指南.html-34d27c15.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ问题与解决.html-c596414a.js" as="script"><link rel="prefetch" href="/blog/assets/SpringBoot RocketMQ入门.html-d4ef1d3d.js" as="script"><link rel="prefetch" href="/blog/assets/Docker安装.html-299af5cc.js" as="script"><link rel="prefetch" href="/blog/assets/Docker实用篇.html-52d0916d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-e263db13.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-9dd24a6d.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0d946030.js" as="script"><link rel="prefetch" href="/blog/assets/Linux虚拟机克隆.html-b438ca2c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-dd625d67.js" as="script"><link rel="prefetch" href="/blog/assets/VMware安装CentOS7.html-a73884c0.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-e2ad7188.js" as="script"><link rel="prefetch" href="/blog/assets/分布式事务.html-794c1916.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-98e4866e.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-2fb772ff.js" as="script"><link rel="prefetch" href="/blog/assets/Redis缓存.html-bd0daed9.js" as="script"><link rel="prefetch" href="/blog/assets/SaaS多租户.html-a2055fe0.js" as="script"><link rel="prefetch" href="/blog/assets/功能权限.html-2d8aaacc.js" as="script"><link rel="prefetch" href="/blog/assets/幂等性（防重复提交）.html-0534ba04.js" as="script"><link rel="prefetch" href="/blog/assets/数据库 MyBatis.html-e382d2a7.js" as="script"><link rel="prefetch" href="/blog/assets/数据权限.html-a5caa49b.js" as="script"><link rel="prefetch" href="/blog/assets/本地缓存.html-f2290b7c.js" as="script"><link rel="prefetch" href="/blog/assets/用户认证.html-9d064fff.js" as="script"><link rel="prefetch" href="/blog/assets/系统日志.html-ee40ac2f.js" as="script"><link rel="prefetch" href="/blog/assets/统一响应和异常处理（错误码）.html-6de026fa.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-31a96e3c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-a6895b4b.js" as="script"><link rel="prefetch" href="/blog/assets/1-MySQL常用的命令.html-ca808bbc.js" as="script"><link rel="prefetch" href="/blog/assets/13-责任链模式.html-37bc270e.js" as="script"><link rel="prefetch" href="/blog/assets/14-命令模式.html-565f0606.js" as="script"><link rel="prefetch" href="/blog/assets/15-解析器模式.html-a1e4bfaa.js" as="script"><link rel="prefetch" href="/blog/assets/16-迭代器模式.html-ead46aeb.js" as="script"><link rel="prefetch" href="/blog/assets/17-中介者模式.html-701b63f8.js" as="script"><link rel="prefetch" href="/blog/assets/18-备忘录模式.html-8cf3d53a.js" as="script"><link rel="prefetch" href="/blog/assets/19-观察者模式.html-dfb01611.js" as="script"><link rel="prefetch" href="/blog/assets/20-状态模式.html-e26f4307.js" as="script"><link rel="prefetch" href="/blog/assets/21-策略模式.html-27dc7c89.js" as="script"><link rel="prefetch" href="/blog/assets/22-模板方法模式.html-6eb9e5b2.js" as="script"><link rel="prefetch" href="/blog/assets/23-访问者模式.html-cf79916d.js" as="script"><link rel="prefetch" href="/blog/assets/1-单例模式.html-89e83bdd.js" as="script"><link rel="prefetch" href="/blog/assets/2-抽象工厂模式.html-f9ba82fa.js" as="script"><link rel="prefetch" href="/blog/assets/3-工厂方法模式.html-716e2ec4.js" as="script"><link rel="prefetch" href="/blog/assets/4-建造者模式.html-f9c85e95.js" as="script"><link rel="prefetch" href="/blog/assets/5-原型模式.html-c346c412.js" as="script"><link rel="prefetch" href="/blog/assets/10-桥接模式.html-58973dc7.js" as="script"><link rel="prefetch" href="/blog/assets/11-组合模式.html-8845d578.js" as="script"><link rel="prefetch" href="/blog/assets/12-享元模式.html-4f0564d0.js" as="script"><link rel="prefetch" href="/blog/assets/6-适配器模式.html-ee4a3eab.js" as="script"><link rel="prefetch" href="/blog/assets/7-装饰器模式.html-9da2ce9b.js" as="script"><link rel="prefetch" href="/blog/assets/8-外观模式.html-de9ba17f.js" as="script"><link rel="prefetch" href="/blog/assets/9-代理模式.html-24224643.js" as="script"><link rel="prefetch" href="/blog/assets/UML类图.html-ee48f6ee.js" as="script"><link rel="prefetch" href="/blog/assets/1-Java8新特性概述.html-ba7370a2.js" as="script"><link rel="prefetch" href="/blog/assets/10-Stream API的中间操作.html-ab41c503.js" as="script"><link rel="prefetch" href="/blog/assets/11-Stream API的终止操作.html-579e0275.js" as="script"><link rel="prefetch" href="/blog/assets/12-Optional类.html-2938f6c0.js" as="script"><link rel="prefetch" href="/blog/assets/13-接口中的默认方法和静态方法.html-4376d340.js" as="script"><link rel="prefetch" href="/blog/assets/14-新日期时间API.html-8cef1169.js" as="script"><link rel="prefetch" href="/blog/assets/15-重复注解与类型注解.html-14c69dac.js" as="script"><link rel="prefetch" href="/blog/assets/2-引入Lambda表达式.html-cbb68b73.js" as="script"><link rel="prefetch" href="/blog/assets/3-Lambda表达式基础语法.html-b874571a.js" as="script"><link rel="prefetch" href="/blog/assets/4-Lambda表达式典型案例.html-02ff3862.js" as="script"><link rel="prefetch" href="/blog/assets/5-函数式接口.html-a567c93c.js" as="script"><link rel="prefetch" href="/blog/assets/6-Java7和Java8的HashMap.html-d45c19ee.js" as="script"><link rel="prefetch" href="/blog/assets/7-方法引用和构造器引用.html-5528bf63.js" as="script"><link rel="prefetch" href="/blog/assets/8-Stream API基础.html-716d9e0b.js" as="script"><link rel="prefetch" href="/blog/assets/9-Stream API的创建案例.html-f8bfe8bc.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ入门.html-aa90e61e.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ部署指南.html-ae39e5df.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ高级.html-ff1c439e.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ简介.html-734c9b0f.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ部署指南.html-73952eb6.js" as="script"><link rel="prefetch" href="/blog/assets/RocketMQ问题与解决.html-2b150a6b.js" as="script"><link rel="prefetch" href="/blog/assets/SpringBoot RocketMQ入门.html-25974b8e.js" as="script"><link rel="prefetch" href="/blog/assets/Docker安装.html-a0389f48.js" as="script"><link rel="prefetch" href="/blog/assets/Docker实用篇.html-ad5b2634.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-3cba7701.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-646aeed4.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-d3ddc6e3.js" as="script"><link rel="prefetch" href="/blog/assets/Linux虚拟机克隆.html-32214cd3.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-cdeca630.js" as="script"><link rel="prefetch" href="/blog/assets/VMware安装CentOS7.html-4cd1bd26.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-d672d3fd.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><img class="logo" src="/blog/images/logo.png" alt="空山木巷"><span class="site-name can-hide">空山木巷</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>容器服务</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/tool/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/tool/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>开发工具</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/tool/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/tool/idea/" class="" aria-label="IDEA"><!--[--><!--]--> IDEA <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/java/java8/1-Java8新特性概述.md" class="" aria-label="java8新特性"><!--[--><!--]--> java8新特性 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/distributed/分布式事务.md" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/db/mysql/1-MySQL常用的命令.md" class="" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/blog/design-patterns/creational/1-单例模式.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/mq/" class="" aria-label="消息队列"><!--[--><!--]--> 消息队列 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/kayson/" class="router-link-active" aria-label="Kayson"><!--[--><!--]--> Kayson <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/seckill/" class="" aria-label="Seckill"><!--[--><!--]--> Seckill <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://gitee.com/jhzhou" rel="noopener noreferrer" target="_blank" aria-label="Gitee"><!--[--><!--]--> Gitee <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/jh-zhou0" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>容器服务</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/tool/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/tool/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>开发工具</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/tool/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/tool/idea/" class="" aria-label="IDEA"><!--[--><!--]--> IDEA <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/java/java8/1-Java8新特性概述.md" class="" aria-label="java8新特性"><!--[--><!--]--> java8新特性 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/distributed/分布式事务.md" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/db/mysql/1-MySQL常用的命令.md" class="" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/blog/design-patterns/creational/1-单例模式.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/mq/" class="" aria-label="消息队列"><!--[--><!--]--> 消息队列 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/kayson/" class="router-link-active" aria-label="Kayson"><!--[--><!--]--> Kayson <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/seckill/" class="" aria-label="Seckill"><!--[--><!--]--> Seckill <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://gitee.com/jhzhou" rel="noopener noreferrer" target="_blank" aria-label="Gitee"><!--[--><!--]--> Gitee <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/jh-zhou0" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">kayson管理系统 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/kayson/统一响应和异常处理（错误码）.md" class="sidebar-item" aria-label="统一响应和异常处理（错误码）"><!--[--><!--]--> 统一响应和异常处理（错误码） <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/数据库 Mybatis.md" class="sidebar-item" aria-label="数据库 Mybatis"><!--[--><!--]--> 数据库 Mybatis <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/系统日志.md" class="sidebar-item" aria-label="系统日志"><!--[--><!--]--> 系统日志 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/用户认证.md" class="sidebar-item" aria-label="用户认证"><!--[--><!--]--> 用户认证 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/功能权限.md" class="sidebar-item" aria-label="功能权限"><!--[--><!--]--> 功能权限 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/数据权限.md" class="sidebar-item" aria-label="数据权限"><!--[--><!--]--> 数据权限 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/SaaS多租户.md" class="sidebar-item" aria-label="SaaS多租户"><!--[--><!--]--> SaaS多租户 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/Redis缓存.md" class="sidebar-item" aria-label="Redis缓存"><!--[--><!--]--> Redis缓存 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/本地缓存.md" class="sidebar-item" aria-label="本地缓存"><!--[--><!--]--> 本地缓存 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/消息队列.md" class="sidebar-item active" aria-label="消息队列"><!--[--><!--]--> 消息队列 <!--[--><!--]--></a><!----></li><li><a href="/blog/kayson/幂等性（防重复提交）.md" class="sidebar-item" aria-label="幂等性（防重复提交）"><!--[--><!--]--> 幂等性（防重复提交） <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="消息队列" tabindex="-1"><a class="header-anchor" href="#消息队列" aria-hidden="true">#</a> 消息队列</h1><p><a href="https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-mq" target="_blank" rel="noopener noreferrer">kayson-spring-boot-starter-mq<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 技术组件，基于 Redis 实现分布式消息队列：</p><ul><li><p>使用 <a href="http://www.redis.cn/topics/pubsub.html" target="_blank" rel="noopener noreferrer">Pub/Sub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>特性，提供【广播】消费的能力。</p></li><li><p>使用 <a href="http://www.redis.cn/topics/streams-intro.html" target="_blank" rel="noopener noreferrer">Stream<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>特性，提供【集群】消费的能力。</p></li></ul><h2 id="_1-广播消费" tabindex="-1"><a class="header-anchor" href="#_1-广播消费" aria-hidden="true">#</a> 1.广播消费</h2><p>广播消费，是指消息发送到 Redis 时，所有消费者（应用 JVM 实例）收到，然后消费成功。如下图所示：</p><p><img src="/blog/kayson/Snipaste_2023-06-14_18-28-46.png" alt="Snipaste_2023-06-14_18-28-46"></p><h3 id="_1-1使用场景" tabindex="-1"><a class="header-anchor" href="#_1-1使用场景" aria-hidden="true">#</a> 1.1使用场景</h3><p>例如说，在应用中，缓存了数据字典等配置表在内存中，可以通过 Redis 广播消费，实现每个应用节点都消费消息，刷新本地内存的缓存。</p><p>又例如说，我们基于 WebSocket 实现了 IM 聊天，在我们给用户主动发送消息时，因为我们不知道用户连接的是哪个提供 WebSocket 的应用，所以可以通过 Redis 广播消费。每个应用判断当前用户是否是和自己提供的 WebSocket 服务连接，如果是，则推送消息给用户。</p><h3 id="_1-2-实现源码" tabindex="-1"><a class="header-anchor" href="#_1-2-实现源码" aria-hidden="true">#</a> 1.2 实现源码</h3><p>广播消费基于 Redis Pub/Sub 实现：</p><p>定义 Redis 消息抽象基类 AbstractRedisMessage</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Redis 消息抽象基类
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRedisMessage</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 头
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 Redis Channel Message 抽象类 AbstractChannelMessage</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Redis Channel Message 抽象类
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelMessage</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRedisMessage</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 获得 Redis Channel
     * 
     * <span class="token keyword">@return</span> Channel
     */</span>
    <span class="token annotation punctuation">@JsonIgnore</span> <span class="token comment">// 避免序列化。原因是，Redis 发布 Channel 消息的时候，已经会指定。</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 RedisMessageInterceptor ，通过实现此接口，可在发送消息前、发送消息后、消费消息前、消费消息后执行一些操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedisMessageInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">sendMessageBefore</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">sendMessageAfter</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">consumeMessageBefore</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">consumeMessageAfter</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 Redis MQ 操作模板类 RedisMQTemplate</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Redis MQ 操作模板类
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisMQTemplate</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 拦截器数组
     */</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisMessageInterceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 发送 Redis 消息，基于 Redis pub/sub 实现
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">message</span> 消息
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelMessage</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sendMessageBefore</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">sendMessageAfter</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 添加拦截器
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">interceptor</span> 拦截器
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token class-name">RedisMessageInterceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessageBefore</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 正序</span>
        interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interceptor <span class="token operator">-&gt;</span> interceptor<span class="token punctuation">.</span><span class="token function">sendMessageBefore</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessageAfter</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 逆序</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessageAfter</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 Redis Pub/Sub 监听器抽象类 AbstractChannelMessageListener，用于实现广播消费</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Redis Pub/Sub 监听器抽象类，用于实现广播消费
 * 
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> 消息类型。一定要填写，不然会报错
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelMessage</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 消息类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> messageType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Redis Channel
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> channel<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * RedisMQTemplate
     */</span>
    <span class="token annotation punctuation">@Setter</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisMQTemplate</span> redisMQTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token class-name">AbstractChannelMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageType <span class="token operator">=</span> <span class="token function">getMessageClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> messageType<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获得 Sub 订阅的 Redis Channel 通道
     * 
     * <span class="token keyword">@return</span> channel
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> channel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">T</span> messageObj <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">consumeMessageBefore</span><span class="token punctuation">(</span>messageObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 消费消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span>messageObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">consumeMessageAfter</span><span class="token punctuation">(</span>messageObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 处理消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">message</span> 消息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 通过解析类上的泛型，获得消息类型
     * 
     * <span class="token keyword">@return</span> 消息类型
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Type</span> type <span class="token operator">=</span> <span class="token class-name">TypeUtil</span><span class="token punctuation">.</span><span class="token function">getTypeArgument</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;类型(%s) 需要设置消息类型&quot;</span><span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">consumeMessageBefore</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> redisMQTemplate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisMessageInterceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> redisMQTemplate<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正序</span>
        interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interceptor <span class="token operator">-&gt;</span> interceptor<span class="token punctuation">.</span><span class="token function">consumeMessageBefore</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">consumeMessageAfter</span><span class="token punctuation">(</span><span class="token class-name">AbstractRedisMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> redisMQTemplate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisMessageInterceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> redisMQTemplate<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 逆序</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consumeMessageAfter</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在配置类 KaysonMQAutoConfiguration 中，注册 RedisMQTemplate Bean对象，创建 Redis Pub/Sub 广播消费的容器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@AutoConfiguration</span><span class="token punctuation">(</span>after <span class="token operator">=</span> <span class="token class-name">KaysonRedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaysonMQAutoConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisMQTemplate</span> <span class="token function">redisMQTemplate</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisMessageInterceptor</span><span class="token punctuation">&gt;</span></span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisMQTemplate</span> redisMQTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisMQTemplate</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加拦截器</span>
        interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>redisMQTemplate<span class="token operator">::</span><span class="token function">addInterceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisMQTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 创建 Redis Pub/Sub 广播消费的容器
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod <span class="token operator">=</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> destroyMethod <span class="token operator">=</span> <span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisMessageListenerContainer</span> <span class="token function">redisMessageListenerContainer</span><span class="token punctuation">(</span>
            <span class="token class-name">RedisMQTemplate</span> redisMQTemplate<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractChannelMessageListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 RedisMessageListenerContainer 对象</span>
        <span class="token class-name">RedisMessageListenerContainer</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 RedisConnection 工厂</span>
        container<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisMQTemplate<span class="token punctuation">.</span><span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequiredConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加监听器</span>
        listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>listener <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            listener<span class="token punctuation">.</span><span class="token function">setRedisMQTemplate</span><span class="token punctuation">(</span>redisMQTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            container<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChannelTopic</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[redisMessageListenerContainer][注册 Channel({}) 对应的监听器({})]&quot;</span><span class="token punctuation">,</span>
                    listener<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> container<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3使用" tabindex="-1"><a class="header-anchor" href="#_1-3使用" aria-hidden="true">#</a> 1.3使用</h3><p>以部门dept为例：</p><p>在 message 包下 dept 包中，创建部门消息类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 部门数据刷新 Message
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeptRefreshMessage</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelMessage</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;system.dept.refresh&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 producer 包下 dept 包中，创建部们消息生产者类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Dept 部门相关消息的 Producer
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeptProducer</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisMQTemplate</span> redisMQTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 发送 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DeptRefreshMessage</span></span><span class="token punctuation">}</span> 消息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendDeptRefreshMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DeptRefreshMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeptRefreshMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisMQTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 consumer 包下 dept 包中，创建部门消息消费者类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 针对 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DeptRefreshMessage</span></span><span class="token punctuation">}</span> 的消费者
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeptRefreshConsumer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeptRefreshMessage</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DeptService</span> deptService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">DeptRefreshMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[onMessage][收到 Dept 刷新消息]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deptService<span class="token punctuation">.</span><span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在新建部门、更新部门等场景下，通过发送消息实现本地缓存实时刷新</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeptServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DeptService</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
	<span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DeptProducer</span> deptProducer<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createDept</span><span class="token punctuation">(</span><span class="token class-name">DeptCreateReqVO</span> reqVO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 发送刷新消息</span>
        deptProducer<span class="token punctuation">.</span><span class="token function">sendDeptRefreshMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-66d6b4fd.js" defer></script>
  </body>
</html>
