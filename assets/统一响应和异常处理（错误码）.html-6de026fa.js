import{_ as p,r as o,o as c,c as l,a as s,d as n,b as e,e as t}from"./app-66d6b4fd.js";const i="/blog/kayson/Snipaste_2023-06-15_14-57-46.png",u="/blog/kayson/Snipaste_2023-06-15_15-07-27.png",r="/blog/kayson/Snipaste_2023-06-15_15-12-10.png",k="/blog/kayson/Snipaste_2023-06-15_15-18-08.png",d={},m=t('<h1 id="统一响应和异常处理-错误码" tabindex="-1"><a class="header-anchor" href="#统一响应和异常处理-错误码" aria-hidden="true">#</a> 统一响应和异常处理（错误码）</h1><h2 id="_1-统一响应" tabindex="-1"><a class="header-anchor" href="#_1-统一响应" aria-hidden="true">#</a> 1. 统一响应</h2><p>后端提供 RESTful API 给前端时，需要响应前端 API 调用是否成功：</p><ul><li>如果成功，成功的数据是什么。后续，前端会将数据渲染到页面上</li><li>如果失败，失败的原因是什么。一般，前端会将原因弹出提示给用户</li></ul><p>因此，需要有<strong>统一响应</strong>，而不能是每个接口定义自己的风格。一般来说，统一响应返回信息如下：</p><ul><li>成功时，返回成功的状态码 + 数据</li><li>失败时，返回失败的状态码 + 错误提示</li></ul>',6),v={href:"https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81",target:"_blank",rel:"noopener noreferrer"},b=s("ul",null,[s("li",null,"业务返回的错误状态码很多，HTTP 响应状态码无法很好的映射。例如说，活动还未开始、订单已取消等等"),s("li",null,"学习成本高，开发者对 HTTP 响应状态码不是很了解。例如说，可能只知道 200、403、404、500 几种常见的")],-1),g=s("h3",{id:"_1-1-commonresult",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_1-1-commonresult","aria-hidden":"true"},"#"),n(" 1.1 CommonResult")],-1),y={href:"https://gitee.com/jhzhou/kayson",target:"_blank",rel:"noopener noreferrer"},E=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 通用返回
 *
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> 数据泛型
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 错误码
     *
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">ErrorCode</span><span class="token punctuation">#</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 返回数据
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 错误提示，用户可阅读
     *
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">ErrorCode</span><span class="token punctuation">#</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span> ()
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 将传入的 result 对象，转换成另外一个泛型结果的对象
     *
     * 因为 A 方法返回的 CommonResult 对象，不满足调用其的 B 方法的返回，所以需要进行转换。
     *
     * <span class="token keyword">@param</span> <span class="token parameter">result</span> 传入的 result 对象
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> 返回的泛型
     * <span class="token keyword">@return</span> 新的 CommonResult 对象
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;code 必须是错误的！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>msg <span class="token operator">=</span> message<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span> <span class="token comment">// 避免 jackson 序列化</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span> <span class="token comment">// 避免 jackson 序列化</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ========= 和 Exception 异常体系集成 =========</span>

    <span class="token doc-comment comment">/**
     * 判断是否有异常。如果有，则抛出 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ServiceException</span></span><span class="token punctuation">}</span> 异常
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServiceException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 服务端异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token function">isServerErrorCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServerException</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 业务异常</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ServiceException</span> serviceException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>serviceException<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>统一响应结果定义如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token comment">// 成功响应</span>
<span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">&quot;kayson&quot;</span>
    <span class="token punctuation">}</span>，
    message<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 失败响应</span>
<span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">&quot;错误原因&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">可以增加 success 字段吗？</p><p>有些团队在实践时，会增加了 <code>success</code> 字段，通过 <code>true</code> 和 <code>false</code> 表示成功还是失败。 这个看每个团队的习惯吧。个人还是偏好基于约定，返回 <code>0</code> 时表示成功。</p></div><p>失败时的 <code>code</code> 字段，使用全局的错误码，稍后在 「4. 错误码」小节来讲解。</p><p>① 在 RESTful API 成功时，定义 Controller 对应方法的返回类型为 CommonResult，并调用 <code>#success(T data)</code>方法来返回。代码如下图：</p><p><img src="`+i+`" alt="Snipaste_2023-06-15_14-57-46"></p><p>CommonResult 的 <code>data</code> 字段是<strong>泛型</strong>，建议定义对应的 VO 类，而不是使用 Map 类。</p><p>② 在 RESTful API 失败时，通过抛出 Exception 异常，具体在 「2. 异常处理」小节。</p><h3 id="_1-2-使用-controlleradvice" tabindex="-1"><a class="header-anchor" href="#_1-2-使用-controlleradvice" aria-hidden="true">#</a> 1.2 使用 <code>@ControllerAdvice</code></h3><p>在 Spring MVC 中，可以使用 <code>@ControllerAdvice</code> 注解，通过 Spring AOP 拦截修改 Controller 方法的返回结果，从而实现全局的统一返回。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ControllerAdvice</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.kayson.springboot.lab05.springmvc.controller&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalResponseBodyHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ResponseBodyAdvice</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">Class</span> converterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">beforeBodyWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span> selectedContentType<span class="token punctuation">,</span>
                                  <span class="token class-name">Class</span> selectedConverterType<span class="token punctuation">,</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果已经是 CommonResult 类型，则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">CommonResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> body<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不是，则包装成 CommonResult 类型</span>
        <span class="token keyword">return</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>::; tip 为什么项目不采用这种方式呢？</p><p>主要原因是，这样的方式“破坏”了方法的定义，导致一些隐性的问题。例如说，Swagger 接口定义错误，展示的响应结果不是 CommonResult。</p><p>还有个原因，部分 RESTful API 不需要自动包装 CommonResult 结果。例如说，第三方支付回调只需要返回 <code>&quot;success&quot;</code> 字符串。 :::</p><p>kayson项目全局响应结果处理定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 全局响应结果（ResponseBody）处理器
 * 
 * 目前，GlobalResponseBodyHandler 的主要作用是，记录 Controller 的返回结果，
 * 方便记录 API 访问日志
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalResponseBodyHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ResponseBodyAdvice</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 避免 IDEA 警告</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> converterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>returnType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 只拦截返回结果为 CommonResult 类型</span>
        <span class="token keyword">return</span> returnType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 避免 IDEA 警告</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">beforeBodyWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span> selectedContentType<span class="token punctuation">,</span> 
                                  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selectedConverterType<span class="token punctuation">,</span> 
                                  <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 记录 Controller 结果</span>
        <span class="token class-name">ServletServerHttpRequest</span> servletServerHttpRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletServerHttpRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> servletRequest <span class="token operator">=</span> servletServerHttpRequest<span class="token punctuation">.</span><span class="token function">getServletRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebFrameworkUtils</span><span class="token punctuation">.</span><span class="token function">setCommonResult</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-异常处理" tabindex="-1"><a class="header-anchor" href="#_2-异常处理" aria-hidden="true">#</a> 2. 异常处理</h2><p>RESTful API 发生异常时，需要拦截 Exception 异常，转换成<strong>统一响应</strong>的格式，否则前端无法处理。</p>`,19),w={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-web/src/main/java/cn/zjh/kayson/framework/web/core/handler/GlobalExceptionHandler.java",target:"_blank",rel:"noopener noreferrer"},C=t('<p><img src="'+u+'" alt="Snipaste_2023-06-15_15-07-27"></p><h3 id="_2-2-filter-的异常" tabindex="-1"><a class="header-anchor" href="#_2-2-filter-的异常" aria-hidden="true">#</a> 2.2 Filter 的异常</h3><p>在请求被 Spring MVC 处理之前，是先经过 Filter 处理的，此时发生异常时，是无法通过 <code>@ExceptionHandler</code> 注解来处理的。只能通过 <code>try catch</code> 的方式来实现，代码如下：</p><p><img src="'+r+`" alt="Snipaste_2023-06-15_15-12-10"></p><h2 id="_3-业务异常" tabindex="-1"><a class="header-anchor" href="#_3-业务异常" aria-hidden="true">#</a> 3. 业务异常</h2><p>在 Service 发生业务异常时，如果进行返回呢？例如说，用户名已经存在，商品库存不足等。常用的方案选择，主要有两种：</p><ul><li>方案一，使用 CommonResult 统一响应结果，里面有错误码和错误提示，然后进行 <code>return</code> 返回</li><li>方案二，使用 ServiceException 统一业务异常，里面有错误码和错误提示，然后进行 <code>throw</code> 抛出</li></ul><p>选择方案一 CommonResult 会存在两个问题：</p><ul><li>因为 Spring <code>@Transactional</code> 声明式事务，是基于异常进行回滚的，如果使用 CommonResult 返回，则事务回滚会非常麻烦</li><li>当调用别的方法时，如果别人返回的是 CommonResult 对象，还需要不断的进行判断，写起来挺麻烦的</li></ul><p>因此，项目采用方案二 ServiceException 异常。</p><h3 id="_3-1-serviceexception" tabindex="-1"><a class="header-anchor" href="#_3-1-serviceexception" aria-hidden="true">#</a> 3.1 ServiceException</h3><p>定义 ServiceException 异常类，继承 RuntimeException 异常类（非受检），用于定义业务异常。代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 业务逻辑异常 Exception
 *
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@NoArgsConstructor</span> <span class="token comment">// 空构造，避免反序列化问题</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 业务错误码
     *
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">ServiceErrorCodeRange</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 错误提示
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> errorCode<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> errorCode<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>::; tip 为什么继承 RuntimeException 异常？</p><p>大多数业务场景下，我们无需处理 ServiceException 业务异常，而是通过 GlobalExceptionHandler 统一处理，转换成对应的 CommonResult 对象，进而提示给前端即可。 如果真的需要处理 ServiceException 时，通过 <code>try catch</code> 的方式进行主动捕获。 :::</p><h3 id="_3-2-serviceexceptionutils" tabindex="-1"><a class="header-anchor" href="#_3-2-serviceexceptionutils" aria-hidden="true">#</a> 3.2 ServiceExceptionUtils</h3>`,16),_={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-common/src/main/java/cn/zjh/kayson/framework/common/exception/util/ServiceExceptionUtils.java",target:"_blank",rel:"noopener noreferrer"},h=s("code",null,"#exception(ErrorCode errorCode, Object... params)",-1),f=s("code",null,"throw",-1),S=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ServiceExceptionUtils.java</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ServiceException</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token doc-comment comment">/** 省略参数 */</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ServiceException</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token doc-comment comment">/** 省略参数 */</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+k+`" alt="Snipaste_2023-06-15_15-18-08"></p><h2 id="_4-错误码" tabindex="-1"><a class="header-anchor" href="#_4-错误码" aria-hidden="true">#</a> 4. 错误码</h2><p>错误码，对应 ErrorCode 类，枚举项目中的错误，全局唯一，方便定位是谁的错、错在哪。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 错误码对象
 *
 * 全局错误码，占用 [0, 999], 参见 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">GlobalErrorCodeConstants</span></span><span class="token punctuation">}</span>
 * 业务异常错误码，占用 [1 000 000 000, +∞)，参见 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ServiceErrorCodeRange</span></span><span class="token punctuation">}</span>
 *
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 错误码
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 错误提示
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-错误码分类" tabindex="-1"><a class="header-anchor" href="#_4-1-错误码分类" aria-hidden="true">#</a> 4.1 错误码分类</h3><p>错误码分成两类：全局的系统错误码、模块的业务错误码。</p><h4 id="_4-1-1-系统错误码" tabindex="-1"><a class="header-anchor" href="#_4-1-1-系统错误码" aria-hidden="true">#</a> 4.1.1 系统错误码</h4>`,8),R={href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status",target:"_blank",rel:"noopener noreferrer"},T=t(`<p>系统错误码定义在 GlobalErrorCodeConstants 类，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 全局错误码枚举
 * 0-999 系统异常编码保留
 *
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GlobalErrorCodeConstants</span> <span class="token punctuation">{</span>

    <span class="token class-name">ErrorCode</span> <span class="token constant">SUCCESS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== 客户端错误段 ==========</span>

    <span class="token class-name">ErrorCode</span> <span class="token constant">BAD_REQUEST</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;请求参数不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">UNAUTHORIZED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">&quot;账号未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">FORBIDDEN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">&quot;没有该操作权限&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">NOT_FOUND</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">&quot;请求未找到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">METHOD_NOT_ALLOWED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">,</span> <span class="token string">&quot;请求方法不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">LOCKED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">423</span><span class="token punctuation">,</span> <span class="token string">&quot;请求失败，请稍后重试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 并发请求，不允许</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">TOO_MANY_REQUESTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">,</span> <span class="token string">&quot;请求过于频繁，请稍后重试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== 服务端错误段 ==========</span>

    <span class="token class-name">ErrorCode</span> <span class="token constant">INTERNAL_SERVER_ERROR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;系统异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">NOT_IMPLEMENTED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">501</span><span class="token punctuation">,</span> <span class="token string">&quot;功能未实现/未开启&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== 自定义错误段 ==========</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">REPEATED_REQUESTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">900</span><span class="token punctuation">,</span> <span class="token string">&quot;重复请求，请稍后重试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重复请求</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">DEMO_DENY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">901</span><span class="token punctuation">,</span> <span class="token string">&quot;演示模式，禁止写操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ErrorCode</span> <span class="token constant">UNKNOWN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">,</span> <span class="token string">&quot;未知错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 是否为服务端错误，参考 HTTP 5XX 错误码段
     *
     * <span class="token keyword">@param</span> <span class="token parameter">code</span> 错误码
     * <span class="token keyword">@return</span> 是否
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isServerErrorCode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> code <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> code <span class="token operator">&gt;=</span> <span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;=</span> <span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">99</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-2-业务错误码" tabindex="-1"><a class="header-anchor" href="#_4-1-2-业务错误码" aria-hidden="true">#</a> 4.1.2 业务错误码</h4><p>模块的业务错误码，按照模块分配错误码的<strong>区间</strong>，避免模块之间的错误码冲突。</p><p>① 业务错误码一共 10 位，分成 4 段，在 ServiceErrorCodeRange 分配，规则与代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 业务异常的错误码区间，解决：解决各模块错误码定义，避免重复，在此只声明不做实际使用
 *
 * 一共 10 位，分成四段
 *
 * 第一段，1 位，类型
 *      1 - 业务级别异常
 *      x - 预留
 * 第二段，3 位，系统类型
 *      001 - 用户系统
 *      002 - 商品系统
 *      003 - 订单系统
 *      004 - 支付系统
 *      005 - 优惠劵系统
 *      ... - ...
 * 第三段，3 位，模块
 *      不限制规则。
 *      一般建议，每个系统里面，可能有多个模块，可以再去做分段。以用户系统为例子：
 *          001 - OAuth2 模块
 *          002 - User 模块
 *          003 - MobileCode 模块
 * 第四段，3 位，错误码
 *       不限制规则。
 *       一般建议，每个模块自增。
 *
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceErrorCodeRange</span> <span class="token punctuation">{</span>

    <span class="token comment">// 模块 infra 错误码区间 [1-001-000-000 ~ 1-002-000-000)</span>
    <span class="token comment">// 模块 system 错误码区间 [1-002-000-000 ~ 1-003-000-000)</span>
    <span class="token comment">// 模块 report 错误码区间 [1-003-000-000 ~ 1-004-000-000)</span>
    <span class="token comment">// 模块 member 错误码区间 [1-004-000-000 ~ 1-005-000-000)</span>
    <span class="token comment">// 模块 pay 错误码区间 [1-007-000-000 ~ 1-008-000-000)</span>
    <span class="token comment">// 模块 bpm 错误码区间 [1-009-000-000 ~ 1-010-000-000)</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),q={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-module-system/kayson-module-system-api/src/main/java/cn/zjh/kayson/module/system/enums/ErrorCodeConstants.java",target:"_blank",rel:"noopener noreferrer"},x=s("code",null,"kayson-module-system",-1),j=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * System 错误码枚举类
 * system 系统，使用 1-002-000-000 段
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ErrorCodeConstants</span> <span class="token punctuation">{</span>

    <span class="token comment">// ========== AUTH 模块 1002000000 ==========</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_LOGIN_BAD_CREDENTIALS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000000</span><span class="token punctuation">,</span> <span class="token string">&quot;登录失败，账号密码不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_LOGIN_USER_DISABLED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000001</span><span class="token punctuation">,</span> <span class="token string">&quot;登录失败，账号被禁用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_LOGIN_CAPTCHA_CODE_ERROR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000004</span><span class="token punctuation">,</span> <span class="token string">&quot;验证码不正确，原因：{}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_THIRD_LOGIN_NOT_BIND</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000005</span><span class="token punctuation">,</span> <span class="token string">&quot;未绑定账号，需要进行绑定&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_TOKEN_EXPIRED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000006</span><span class="token punctuation">,</span> <span class="token string">&quot;Token 已经过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">AUTH_MOBILE_NOT_EXISTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002000007</span><span class="token punctuation">,</span> <span class="token string">&quot;手机号不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== 菜单模块 1002001000 ==========</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_NAME_DUPLICATE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001000</span><span class="token punctuation">,</span> <span class="token string">&quot;已经存在该名字的菜单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_PARENT_NOT_EXISTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001001</span><span class="token punctuation">,</span> <span class="token string">&quot;父菜单不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_PARENT_ERROR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001002</span><span class="token punctuation">,</span> <span class="token string">&quot;不能设置自己为父菜单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_NOT_EXISTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001003</span><span class="token punctuation">,</span> <span class="token string">&quot;菜单不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_EXISTS_CHILDREN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001004</span><span class="token punctuation">,</span> <span class="token string">&quot;存在子菜单，无法删除&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ErrorCode</span> <span class="token constant">MENU_PARENT_NOT_DIR_OR_MENU</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">(</span><span class="token number">1002001005</span><span class="token punctuation">,</span> <span class="token string">&quot;父菜单的类型必须是目录或者菜单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1);function A(N,O){const a=o("ExternalLinkIcon");return c(),l("div",null,[m,s("p",null,[n("在标准的 RESTful API 的定义，是推荐使用 "),s("a",v,[n("HTTP 响应状态码 (opens new window)"),e(a)]),n("作为状态码。一般来说，我们实践很少这么去做，主要原因如下：")]),b,g,s("p",null,[s("a",y,[n("kayson"),e(a)]),n(" 项目在实践时，将状态码放在 Response Body 响应内容中返回。一共有 3 个字段，通过 CommonResult 定义如下：")]),E,s("p",null,[n("在 Spring MVC 中，通过 @ControllerAdvice + @ExceptionHandler 注解，声明将指定类型的异常，转换成对应的 CommonResult 响应。实现的代码，可见 "),s("a",w,[n("GlobalExceptionHandler"),e(a)]),n(" 类，部分代码如下：")]),C,s("p",null,[n("在 Service 需抛出业务异常时，通过调用 "),s("a",_,[n("ServiceExceptionUtils"),e(a)]),n(" 的 "),h,n(" 方法来构建 ServiceException 异常，然后使用 "),f,n(" 进行抛出。代码如下：")]),S,s("p",null,[n("全局的系统错误码，使用 0-999 错误码段，和 "),s("a",R,[n("HTTP 响应状态码"),e(a)]),n("对应。虽然说，HTTP 响应状态码作为业务使用表达能力偏弱，但是使用在系统层面还是非常不错的。")]),T,s("p",null,[n("② 每个业务模块，定义自己的 "),s("a",q,[n("ErrorCodeConstants"),e(a)]),n(" 错误码枚举类。以 "),x,n(" 模块举例子，代码如下：")]),j])}const H=p(d,[["render",A],["__file","统一响应和异常处理（错误码）.html.vue"]]);export{H as default};
