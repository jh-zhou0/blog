import{_ as p,r as o,o as c,c as l,a as s,d as n,b as e,e as t}from"./app-66d6b4fd.js";const i="/blog/kayson/Snipaste_2023-06-13_14-37-47.png",u="/blog/kayson/Snipaste_2023-06-13_14-39-46.png",r="/blog/kayson/Snipaste_2023-06-13_14-41-02.png",d="/blog/kayson/Snipaste_2023-06-13_14-42-06.png",k="/blog/kayson/Snipaste_2023-06-13_15-34-14.png",v={},m=s("h1",{id:"saaså¤šç§Ÿæˆ·",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#saaså¤šç§Ÿæˆ·","aria-hidden":"true"},"#"),n(" SaaSå¤šç§Ÿæˆ·")],-1),b=s("h2",{id:"_1-å¤šç§Ÿæˆ·æ˜¯ä»€ä¹ˆ",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_1-å¤šç§Ÿæˆ·æ˜¯ä»€ä¹ˆ","aria-hidden":"true"},"#"),n(" 1. å¤šç§Ÿæˆ·æ˜¯ä»€ä¹ˆï¼Ÿ")],-1),h=s("p",null,[n("å¤šç§Ÿæˆ·ï¼Œç®€å•æ¥è¯´æ˜¯æŒ‡"),s("strong",null,"ä¸€ä¸ª"),n("ä¸šåŠ¡ç³»ç»Ÿï¼Œå¯ä»¥ä¸º"),s("strong",null,"å¤šä¸ª"),n("ç»„ç»‡æœåŠ¡ï¼Œå¹¶ä¸”ç»„ç»‡ä¹‹é—´çš„æ•°æ®æ˜¯"),s("strong",null,"éš”ç¦»"),n("çš„ã€‚")],-1),g={href:"https://gitee.com/jhzhou/kayson",target:"_blank",rel:"noopener noreferrer"},y=s("strong",null,"ä¸€ä¸ªå…¬å¸å°±æ˜¯ä¸€ä¸ªç§Ÿæˆ·",-1),f=t('<h2 id="_2-æ•°æ®éš”ç¦»æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®éš”ç¦»æ–¹æ¡ˆ" aria-hidden="true">#</a> 2. æ•°æ®éš”ç¦»æ–¹æ¡ˆ</h2><p>å¤šç§Ÿæˆ·çš„æ•°æ®éš”ç¦»æ–¹æ¡ˆï¼Œå¯ä»¥åˆ†æˆåˆ†æˆä¸‰ç§ï¼š</p><ol><li>DATASOURCE æ¨¡å¼ï¼šç‹¬ç«‹æ•°æ®åº“</li><li>SCHEMA æ¨¡å¼ï¼šå…±äº«æ•°æ®åº“ï¼Œç‹¬ç«‹ Schema</li><li>COLUMN æ¨¡å¼ï¼šå…±äº«æ•°æ®åº“ï¼Œå…±äº« Schemaï¼Œå…±äº«æ•°æ®è¡¨</li></ol><h3 id="_2-1-datasource-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-1-datasource-æ¨¡å¼" aria-hidden="true">#</a> 2.1 DATASOURCE æ¨¡å¼</h3><p>ä¸€ä¸ªç§Ÿæˆ·ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™ç§æ–¹æ¡ˆçš„ç”¨æˆ·æ•°æ®éš”ç¦»çº§åˆ«æœ€é«˜ï¼Œå®‰å…¨æ€§æœ€å¥½ï¼Œä½†æˆæœ¬ä¹Ÿé«˜ã€‚</p><p><img src="'+i+'" alt="Snipaste_2023-06-13_14-37-47"></p><ul><li>ä¼˜ç‚¹ï¼šä¸ºä¸åŒçš„ç§Ÿæˆ·æä¾›ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œæœ‰åŠ©äºç®€åŒ–æ•°æ®æ¨¡å‹çš„æ‰©å±•è®¾è®¡ï¼Œæ»¡è¶³ä¸åŒç§Ÿæˆ·çš„ç‹¬ç‰¹éœ€æ±‚ï¼›å¦‚æœå‡ºç°æ•…éšœï¼Œæ¢å¤æ•°æ®æ¯”è¾ƒç®€å•ã€‚</li><li>ç¼ºç‚¹ï¼šå¢å¤§äº†æ•°æ®åº“çš„å®‰è£…æ•°é‡ï¼Œéšä¹‹å¸¦æ¥ç»´æŠ¤æˆæœ¬å’Œè´­ç½®æˆæœ¬çš„å¢åŠ ã€‚</li></ul><h3 id="_2-2-schema-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-2-schema-æ¨¡å¼" aria-hidden="true">#</a> 2.2 SCHEMA æ¨¡å¼</h3><p>å¤šä¸ªæˆ–æ‰€æœ‰ç§Ÿæˆ·å…±äº«æ•°æ®åº“ï¼Œä½†ä¸€ä¸ªç§Ÿæˆ·ä¸€ä¸ªè¡¨ã€‚</p><p><img src="'+u+'" alt="Snipaste_2023-06-13_14-39-46"></p><ul><li>ä¼˜ç‚¹ï¼šä¸ºå®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„ç§Ÿæˆ·æä¾›äº†ä¸€å®šç¨‹åº¦çš„é€»è¾‘æ•°æ®éš”ç¦»ï¼Œå¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»ï¼›æ¯ä¸ªæ•°æ®åº“å¯ä»¥æ”¯æŒæ›´å¤šçš„ç§Ÿæˆ·æ•°é‡ã€‚</li><li>ç¼ºç‚¹ï¼šå¦‚æœå‡ºç°æ•…éšœï¼Œæ•°æ®æ¢å¤æ¯”è¾ƒå›°éš¾ï¼Œå› ä¸ºæ¢å¤æ•°æ®åº“å°†ç‰µæ‰¯åˆ°å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®ï¼› å¦‚æœéœ€è¦è·¨ç§Ÿæˆ·ç»Ÿè®¡æ•°æ®ï¼Œå­˜åœ¨ä¸€å®šå›°éš¾ã€‚</li></ul><h3 id="_2-3-column-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-3-column-æ¨¡å¼" aria-hidden="true">#</a> 2.3 COLUMN æ¨¡å¼</h3><p>å…±äº«æ•°æ®åº“ï¼Œå…±äº«æ•°æ®æ¶æ„ã€‚ç§Ÿæˆ·å…±äº«åŒä¸€ä¸ªæ•°æ®åº“ã€åŒä¸€ä¸ªè¡¨ï¼Œä½†åœ¨è¡¨ä¸­é€šè¿‡ <code>tenant_id</code> å­—æ®µåŒºåˆ†ç§Ÿæˆ·çš„æ•°æ®ã€‚è¿™æ˜¯å…±äº«ç¨‹åº¦æœ€é«˜ã€éš”ç¦»çº§åˆ«æœ€ä½çš„æ¨¡å¼ã€‚</p><p><img src="'+r+'" alt="Snipaste_2023-06-13_14-41-02"></p><ul><li>ä¼˜ç‚¹ï¼šç»´æŠ¤å’Œè´­ç½®æˆæœ¬æœ€ä½ï¼Œå…è®¸æ¯ä¸ªæ•°æ®åº“æ”¯æŒçš„ç§Ÿæˆ·æ•°é‡æœ€å¤šã€‚</li><li>ç¼ºç‚¹ï¼šéš”ç¦»çº§åˆ«æœ€ä½ï¼Œå®‰å…¨æ€§æœ€ä½ï¼Œéœ€è¦åœ¨è®¾è®¡å¼€å‘æ—¶åŠ å¤§å¯¹å®‰å…¨çš„å¼€å‘é‡ï¼›æ•°æ®å¤‡ä»½å’Œæ¢å¤æœ€å›°éš¾ï¼Œéœ€è¦é€è¡¨é€æ¡å¤‡ä»½å’Œè¿˜åŸã€‚</li></ul><h3 id="_2-4-æ–¹æ¡ˆé€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#_2-4-æ–¹æ¡ˆé€‰æ‹©" aria-hidden="true">#</a> 2.4 æ–¹æ¡ˆé€‰æ‹©</h3><p><img src="'+d+'" alt="Snipaste_2023-06-13_14-42-06"></p><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ COLUMN æ¨¡å¼ï¼Œå¼€å‘ã€è¿ç»´ç®€å•ï¼Œä»¥æœ€å°‘çš„æœåŠ¡å™¨ä¸ºæœ€å¤šçš„ç§Ÿæˆ·æä¾›æœåŠ¡ã€‚</li><li>ç§Ÿæˆ·è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œæˆ–è€…ä¸€äº›ç§Ÿæˆ·å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ DATASOURCE æ¨¡å¼ï¼Œå½“ç„¶å®ƒä¹Ÿç›¸å¯¹å¤æ‚çš„å¤šã€‚</li><li>ä¸æ¨èé‡‡ç”¨ SCHEMA æ¨¡å¼ï¼Œå› ä¸ºå®ƒçš„ä¼˜ç‚¹å¹¶ä¸æ˜æ˜¾ï¼Œè€Œä¸”å®ƒçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼ŒåŒæ—¶å¯¹å¤æ‚ SQL æ”¯æŒä¸€èˆ¬ã€‚</li></ul><div class="custom-container tip"><p class="custom-container-title">kayson é¡¹ç›®é‡‡ç”¨ COLUMN æ¨¡å¼ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><ul><li>ç»´æŠ¤æˆæœ¬ä½</li><li>æ€§èƒ½è¶³å¤Ÿæ»¡è¶³</li></ul></div><div class="custom-container tip"><p class="custom-container-title">æœªæ¥ä¼˜åŒ–ï¼Ÿ</p><ul><li><p>å°ç§Ÿæˆ·ï¼šåŸºäº Sharding-Sphere åˆ†åº“åˆ†è¡¨</p></li><li><p>å¤§ç§Ÿæˆ·ï¼šç‹¬ç«‹æ•°æ®åº“ï¼Œç”šè‡³ä¸€ä¸ªå¤§ç§Ÿæˆ·æ˜¯å¤šä¸ªåº“ + è¡¨ï¼ˆä¹Ÿåˆ†åº“åˆ†è¡¨ï¼‰</p></li></ul></div><h2 id="_3-å¤šç§Ÿæˆ·çš„å¼€å…³" tabindex="-1"><a class="header-anchor" href="#_3-å¤šç§Ÿæˆ·çš„å¼€å…³" aria-hidden="true">#</a> 3. å¤šç§Ÿæˆ·çš„å¼€å…³</h2><p>ç³»ç»Ÿæœ‰ä¸¤ä¸ªé…ç½®é¡¹ï¼Œè®¾ç½®ä¸º <code>true</code> æ—¶å¼€å¯å¤šç§Ÿæˆ·ï¼Œè®¾ç½®ä¸º <code>false</code> æ—¶å…³é—­å¤šç§Ÿæˆ·ã€‚</p><p>æ³¨æ„ï¼Œä¸¤è€…éœ€è¦ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼</p><table><thead><tr><th style="text-align:center;"><strong>é…ç½®é¡¹</strong></th><th style="text-align:center;"><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td style="text-align:center;"><code>kayson.tenant.enable</code></td><td style="text-align:center;">åç«¯å¤šç§Ÿæˆ·å¼€å…³ï¼ˆyamlæ–‡ä»¶ä¸­ï¼‰</td></tr><tr><td style="text-align:center;"><code>VUE_APP_TENANT_ENABLE</code></td><td style="text-align:center;">å‰ç«¯å¤šç§Ÿæˆ·å¼€å…³ï¼ˆ.envæ–‡ä»¶ä¸­ï¼‰</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ä¸ªé…ç½®é¡¹ï¼Ÿ</p><p>å‰ç«¯ç™»å½•ç•Œé¢éœ€è¦ä½¿ç”¨åˆ°å¤šç§Ÿæˆ·çš„é…ç½®é¡¹ï¼Œä»åç«¯åŠ è½½é…ç½®é¡¹çš„è¯ï¼Œä½“éªŒä¼šæ¯”è¾ƒå·®ã€‚</p></div><h2 id="_4-å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#_4-å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½" aria-hidden="true">#</a> 4. å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½</h2><p>å¤šç§Ÿæˆ·ä¸»è¦æœ‰ä¸¤ä¸ªä¸šåŠ¡åŠŸèƒ½ï¼š</p><ul><li>ç§Ÿæˆ·ç®¡ç†ï¼šé…ç½®ç³»ç»Ÿç§Ÿæˆ·ï¼Œåˆ›å»ºå¯¹åº”çš„ç§Ÿæˆ·ç®¡ç†å‘˜</li><li>ç§Ÿæˆ·å¥—é¤ï¼šé…ç½®ç§Ÿæˆ·å¥—é¤ï¼Œè‡ªå®šæ¯ä¸ªç§Ÿæˆ·çš„èœå•ã€æ“ä½œã€æŒ‰é’®çš„æƒé™</li></ul><h2 id="_5-å¤šç§Ÿæˆ·çš„æŠ€æœ¯ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#_5-å¤šç§Ÿæˆ·çš„æŠ€æœ¯ç»„ä»¶" aria-hidden="true">#</a> 5. å¤šç§Ÿæˆ·çš„æŠ€æœ¯ç»„ä»¶</h2>',29),w={href:"https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-biz-tenant",target:"_blank",rel:"noopener noreferrer"},_=s("h3",{id:"_5-1-ç§Ÿæˆ·ä¸Šä¸‹æ–‡",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_5-1-ç§Ÿæˆ·ä¸Šä¸‹æ–‡","aria-hidden":"true"},"#"),n(" 5.1 ç§Ÿæˆ·ä¸Šä¸‹æ–‡")],-1),T={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/core/context/TenantContextHolder.java",target:"_blank",rel:"noopener noreferrer"},I=t(`<p>é€šè¿‡è°ƒç”¨ TenantContextHolder çš„ <code>#getTenantId()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—å½“å‰çš„ç§Ÿæˆ·ç¼–å·ã€‚ç»ç»ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¹¶ä¸éœ€è¦ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡ Holder
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantContextHolder</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * å½“å‰ç§Ÿæˆ·ç¼–å·
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">TENANT_ID</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ˜¯å¦å¿½ç•¥ç§Ÿæˆ·
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">IGNORE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è·å¾—ç§Ÿæˆ·ç¼–å·ã€‚
     *
     * <span class="token keyword">@return</span> ç§Ÿæˆ·ç¼–å·
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">TENANT_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è·å¾—ç§Ÿæˆ·ç¼–å·ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡º NullPointerException å¼‚å¸¸
     *
     * <span class="token keyword">@return</span> ç§Ÿæˆ·ç¼–å·
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getRequiredTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> tenantId <span class="token operator">=</span> <span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tenantId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;TenantContextHolder ä¸å­˜åœ¨ç§Ÿæˆ·ç¼–å·!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tenantId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTenantId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> tenantId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">TENANT_ID</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setIgnore</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">IGNORE</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ignore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å½“å‰æ˜¯å¦å¿½ç•¥ç§Ÿæˆ·
     *
     * <span class="token keyword">@return</span> æ˜¯å¦å¿½ç•¥
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">IGNORE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">TENANT_ID</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">IGNORE</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-web-å±‚" tabindex="-1"><a class="header-anchor" href="#_5-2-web-å±‚" aria-hidden="true">#</a> 5.2 Web å±‚</h3><p>å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤šç§Ÿæˆ· Context Web è¿‡æ»¤å™¨
 * å°†è¯·æ±‚ Header ä¸­çš„ tenant-id è§£æå‡ºæ¥ï¼Œæ·»åŠ åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TenantContextHolder</span></span><span class="token punctuation">}</span> ä¸­ï¼Œè¿™æ ·åç»­çš„ DB ç­‰æ“ä½œï¼Œå¯ä»¥è·å¾—åˆ°ç§Ÿæˆ·ç¼–å·ã€‚
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantContextWebFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> tenantId <span class="token operator">=</span> <span class="token class-name">WebFrameworkUtils</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tenantId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">setTenantId</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‰ç«¯çš„æ¯ä¸ªè¯·æ±‚ Header <strong>å¿…é¡»</strong>å¸¦ä¸Š <code>tenant-id</code>ï¼Œå€¼ä¸ºç§Ÿæˆ·ç¼–å·ï¼Œå³ <code>system_tenant</code> è¡¨çš„ä¸»é”®ç¼–å·ã€‚</p><p>å¦‚æœä¸å¸¦è¯¥è¯·æ±‚å¤´ï¼Œä¼šæŠ¥â€œç§Ÿæˆ·çš„è¯·æ±‚æœªä¼ é€’ï¼Œè¯·è¿›è¡Œæ’æŸ¥â€é”™è¯¯æç¤ºã€‚</p><p>ğŸ˜œ é€šè¿‡ <code>kayson.tenant.ignore-urls</code> é…ç½®é¡¹ï¼Œå¯ä»¥è®¾ç½®å“ªäº› URL æ— éœ€å¸¦è¯¥è¯·æ±‚å¤´ã€‚</p><h3 id="_5-3-security-å±‚" tabindex="-1"><a class="header-anchor" href="#_5-3-security-å±‚" aria-hidden="true">#</a> 5.3 Security å±‚</h3><p>ä¸»è¦æ˜¯æ ¡éªŒç™»å½•çš„ç”¨æˆ·ï¼Œæ ¡éªŒæ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ç§Ÿæˆ·ï¼Œé¿å…è¶Šæƒé—®é¢˜ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤šç§Ÿæˆ· Security Web è¿‡æ»¤å™¨
 * 1.å¦‚æœæ˜¯ç™»é™†çš„ç”¨æˆ·ï¼Œæ ¡éªŒæ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ç§Ÿæˆ·ï¼Œé¿å…è¶Šæƒé—®é¢˜ã€‚
 * 2.å¦‚æœæœªç™»å½•ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¿½ç•¥çš„ url
 *  2.1 æ˜¯ï¼Œè‹¥æœªä¼ é€’ç§Ÿæˆ·ç¼–å·ï¼Œåˆ™é»˜è®¤å¿½ç•¥ç§Ÿæˆ·ç¼–å·ï¼Œé¿å…æŠ¥é”™
 *  2.2 ä¸æ˜¯ï¼Œåˆ¤æ–­æ˜¯å¦æºå¸¦tenant_idï¼Œæ ¡éªŒç§Ÿæˆ·æ˜¯åˆæ³•ï¼Œä¾‹å¦‚è¯´è¢«ç¦ç”¨ã€åˆ°æœŸ
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantSecurityWebFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ApiRequestFilter</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TenantProperties</span> tenantProperties<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GlobalExceptionHandler</span> globalExceptionHandler<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AntPathMatcher</span> pathMatcher<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TenantFrameworkService</span> tenantFrameworkService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TenantSecurityWebFilter</span><span class="token punctuation">(</span><span class="token class-name">WebProperties</span> webProperties<span class="token punctuation">,</span>
                                   <span class="token class-name">TenantProperties</span> tenantProperties<span class="token punctuation">,</span>
                                   <span class="token class-name">GlobalExceptionHandler</span> globalExceptionHandler<span class="token punctuation">,</span>
                                   <span class="token class-name">TenantFrameworkService</span> tenantFrameworkService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>webProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tenantProperties <span class="token operator">=</span> tenantProperties<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>globalExceptionHandler <span class="token operator">=</span> globalExceptionHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tenantFrameworkService <span class="token operator">=</span> tenantFrameworkService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> tenantId <span class="token operator">=</span> <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">SecurityFrameworkUtils</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 1.å¦‚æœæ˜¯ç™»é™†çš„ç”¨æˆ·ï¼Œæ ¡éªŒæ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ç§Ÿæˆ·ï¼Œé¿å…è¶Šæƒé—®é¢˜ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœè·å–ä¸åˆ°ç§Ÿæˆ·ç¼–å·ï¼Œåˆ™å°è¯•ä½¿ç”¨ç™»é™†ç”¨æˆ·çš„ç§Ÿæˆ·ç¼–å·</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tenantId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tenantId <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">setTenantId</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœä¼ é€’äº†ç§Ÿæˆ·ç¼–å·ï¼Œåˆ™è¿›è¡Œæ¯”å¯¹ç§Ÿæˆ·ç¼–å·ï¼Œé¿å…è¶Šæƒé—®é¢˜</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[doFilterInternal][ç§Ÿæˆ·({}) User({}/{}) è¶Šæƒè®¿é—®ç§Ÿæˆ·({}) URL({}/{})]&quot;</span><span class="token punctuation">,</span>
                        loginUser<span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getUserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">writeJSON</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;æ‚¨æ— æƒè®¿é—®è¯¥ç§Ÿæˆ·çš„æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 2.å¦‚æœæœªç™»å½•ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¿½ç•¥çš„ url</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIgnoreUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœæ˜¯å…è®¸å¿½ç•¥ç§Ÿæˆ·çš„ URLï¼Œè‹¥æœªä¼ é€’ç§Ÿæˆ·ç¼–å·ï¼Œåˆ™é»˜è®¤å¿½ç•¥ç§Ÿæˆ·ç¼–å·ï¼Œé¿å…æŠ¥é”™</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tenantId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">setIgnore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœéå…è®¸å¿½ç•¥ç§Ÿæˆ·çš„ URLï¼Œåˆ™æ ¡éªŒç§Ÿæˆ·æ˜¯å¦åˆæ³•</span>
            <span class="token comment">// å¦‚æœè¯·æ±‚æœªå¸¦ç§Ÿæˆ·çš„ç¼–å·ï¼Œä¸å…è®¸è®¿é—®ã€‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tenantId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[doFilterInternal][URL({}/{}) æœªä¼ é€’ç§Ÿæˆ·ç¼–å·]&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">writeJSON</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;è¯·æ±‚çš„ç§Ÿæˆ·æ ‡è¯†æœªä¼ é€’ï¼Œè¯·è¿›è¡Œæ’æŸ¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ ¡éªŒç§Ÿæˆ·æ˜¯åˆæ³•ï¼Œä¾‹å¦‚è¯´è¢«ç¦ç”¨ã€åˆ°æœŸ</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                tenantFrameworkService<span class="token punctuation">.</span><span class="token function">validateTenant</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> globalExceptionHandler<span class="token punctuation">.</span><span class="token function">allExceptionHandler</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">writeJSON</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// ç»§ç»­è¿‡æ»¤</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIgnoreUrl</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¿«é€ŸåŒ¹é…ï¼Œä¿è¯æ€§èƒ½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tenantProperties<span class="token punctuation">.</span><span class="token function">getIgnoreUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// é€ä¸ª Ant è·¯å¾„åŒ¹é…</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> url <span class="token operator">:</span> tenantProperties<span class="token punctuation">.</span><span class="token function">getIgnoreUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-db-å±‚" tabindex="-1"><a class="header-anchor" href="#_5-4-db-å±‚" aria-hidden="true">#</a> 5.4 DB å±‚</h3>`,12),C={href:"https://baomidou.com/pages/aef2f2/",target:"_blank",rel:"noopener noreferrer"},R=t('<p>æ ¸å¿ƒï¼šæ¯æ¬¡å¯¹æ•°æ®åº“æ“ä½œæ—¶ï¼Œå®ƒä¼š<strong>è‡ªåŠ¨</strong>æ‹¼æ¥ <code>WHERE tenant_id = ?</code> æ¡ä»¶æ¥è¿›è¡Œç§Ÿæˆ·çš„è¿‡æ»¤ï¼Œå¹¶ä¸”åŸºæœ¬æ”¯æŒæ‰€æœ‰çš„ SQL åœºæ™¯ã€‚</p><p>â‘  <strong>éœ€è¦</strong>å¼€å¯å¤šç§Ÿæˆ·çš„è¡¨ï¼Œå¿…é¡»æ·»åŠ  <code>tenant_id</code> å­—æ®µã€‚ä¾‹å¦‚è¯´ <code>system_users</code>ã€<code>system_role</code> ç­‰è¡¨ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>system_role<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n   <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;è§’è‰²ID&#39;</span><span class="token punctuation">,</span>\n   <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;è§’è‰²åç§°&#39;</span><span class="token punctuation">,</span>\n   <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;ç§Ÿæˆ·ç¼–å·&#39;</span><span class="token punctuation">,</span>\n   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;è§’è‰²ä¿¡æ¯è¡¨&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',3),j=s("code",null,"tenantId",-1),x={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/core/db/TenantBaseDO.java",target:"_blank",rel:"noopener noreferrer"},S=t(`<p>â‘¡ <strong>æ— éœ€</strong>å¼€å¯å¤šç§Ÿæˆ·çš„è¡¨ï¼Œéœ€è¦æ·»åŠ è¡¨ååˆ° <code>kayson.tenant.ignore-tables</code> é…ç½®é¡¹ç›®ã€‚</p><p>å¦‚æœä¸é…ç½®çš„è¯ï¼ŒMyBatis Plus ä¼šè‡ªåŠ¨æ‹¼æ¥ <code>WHERE tenant_id = ?</code> æ¡ä»¶ï¼Œå¯¼è‡´æŠ¥ <code>tenant_id</code> å­—æ®µä¸å­˜åœ¨çš„é”™è¯¯ã€‚</p><p>å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åŸºäº MyBatis Plus å¤šç§Ÿæˆ·çš„åŠŸèƒ½ï¼Œå®ç° DB å±‚é¢çš„å¤šç§Ÿæˆ·çš„åŠŸèƒ½
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantDatabaseInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">TenantLineHandler</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ignoreTables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TenantDatabaseInterceptor</span><span class="token punctuation">(</span><span class="token class-name">TenantProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸åŒ DB ä¸‹ï¼Œå¤§å°å†™çš„ä¹ æƒ¯ä¸åŒï¼Œæ‰€ä»¥éœ€è¦éƒ½æ·»åŠ è¿›å»</span>
        properties<span class="token punctuation">.</span><span class="token function">getIgnoreTables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>table <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            ignoreTables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ignoreTables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åœ¨ OracleKeyGenerator ä¸­ï¼Œç”Ÿæˆä¸»é”®æ—¶ï¼Œä¼šæŸ¥è¯¢è¿™ä¸ªè¡¨ï¼ŒæŸ¥è¯¢è¿™ä¸ªè¡¨åï¼Œä¼šè‡ªåŠ¨æ‹¼æ¥ TENANT_ID å¯¼è‡´æŠ¥é”™</span>
        ignoreTables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;DUAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Expression</span> <span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span><span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequiredTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">ignoreTable</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">isIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// â‘  å…¨å±€å¿½ç•¥å¤šç§Ÿæˆ·</span>
                <span class="token operator">||</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ignoreTables<span class="token punctuation">,</span> tableName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// â‘¡ å¿½ç•¥å¤šç§Ÿæˆ·çš„è¡¨</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),E={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/config/KaysonTenantAutoConfiguration.java",target:"_blank",rel:"noopener noreferrer"},U=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DB</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TenantLineInnerInterceptor</span> <span class="token function">tenantLineInnerInterceptor</span><span class="token punctuation">(</span><span class="token class-name">TenantProperties</span> properties<span class="token punctuation">,</span>
                                                             <span class="token class-name">MybatisPlusInterceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TenantLineInnerInterceptor</span> inner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TenantLineInnerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TenantDatabaseInterceptor</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ åˆ° interceptor ä¸­</span>
    <span class="token comment">// éœ€è¦åŠ åœ¨é¦–ä¸ªï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨åˆ†é¡µæ’ä»¶å‰é¢ã€‚è¿™ä¸ªæ˜¯ MyBatis Plus çš„è§„å®š</span>
    <span class="token class-name">MyBatisUtils</span><span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">,</span> inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> inner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-redis-å±‚" tabindex="-1"><a class="header-anchor" href="#_5-5-redis-å±‚" aria-hidden="true">#</a> 5.5 Redis å±‚</h3><p>ç”±äº Redis ä¸åŒäº DB æœ‰ <code>tenant_id</code> å­—æ®µï¼Œæ— æ³•é€šè¿‡ç±»ä¼¼ <code>WHERE tenant_id</code> = ? çš„æ–¹å¼è¿‡æ»¤ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡åœ¨ Redis Key ä¸Šå¢åŠ  <code>:t{tenantId}</code> åç¼€çš„æ–¹å¼ï¼Œè¿›è¡Œç§Ÿæˆ·ä¹‹é—´çš„éš”ç¦»ã€‚</p><p>ä¾‹å¦‚è¯´ï¼Œå‡è®¾ Redis Key æ˜¯ <code>user:%d</code>ï¼Œç¤ºä¾‹æ˜¯ <code>user:1024</code>ï¼›å¯¹åº”åˆ°å¤šç§Ÿæˆ· 1 çš„ Redis Key æ˜¯ <code>user:t1::1024</code>ã€‚</p><div class="custom-container tip"><p class="custom-container-title">ä¸ºä»€ä¹ˆ Redis Key è¦å¤šç§Ÿæˆ·éš”ç¦»å‘¢ï¼Ÿ</p><ul><li>â‘  åœ¨ä½¿ç”¨ DATASOURCE æ¨¡å¼æ—¶ï¼Œä¸åŒåº“çš„ç›¸åŒè¡¨çš„ id å¯èƒ½ç›¸åŒï¼Œä¾‹å¦‚è¯´ A åº“çš„ç”¨æˆ·ï¼Œå’Œ B åº“çš„ç”¨æˆ·éƒ½æ˜¯ 1024ï¼Œç›´æ¥ç¼“å­˜ä¼šå­˜åœ¨ Redis Key çš„å†²çªã€‚</li><li>â‘¡ åœ¨æ‰€æœ‰æ¨¡å¼ä¸‹ï¼Œè·¨ç§Ÿæˆ·å¯èƒ½å­˜åœ¨ç›¸åŒçš„éœ€è¦å”¯ä¸€çš„æ•°æ®ï¼Œä¾‹å¦‚è¯´ç”¨æˆ·çš„æ‰‹æœºå·ï¼Œç›´æ¥ç¼“å­˜ä¼šå­˜åœ¨ Redis Key çš„å†²çªã€‚</li></ul></div><p><strong>åŸºäº Spring Cache + Redis å®ç°</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤šç§Ÿæˆ·çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheManager</span></span><span class="token punctuation">}</span> å®ç°ç±»
 * 
 * æ“ä½œæŒ‡å®š name çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Cache</span></span><span class="token punctuation">}</span> æ—¶ï¼Œè‡ªåŠ¨æ‹¼æ¥ç§Ÿæˆ·åç¼€ï¼Œæ ¼å¼ä¸º name + &quot;:&quot; + tenantId + åç¼€
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantRedisCacheManager</span> <span class="token keyword">extends</span> <span class="token class-name">RedisCacheManager</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token class-name">TenantRedisCacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisCacheWriter</span> cacheWriter<span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span> defaultCacheConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>cacheWriter<span class="token punctuation">,</span> defaultCacheConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœå¼€å¯å¤šç§Ÿæˆ·ï¼Œåˆ™ name æ‹¼æ¥ç§Ÿæˆ·åç¼€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">isIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span><span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// ç»§ç»­åŸºäºçˆ¶æ–¹æ³•</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,7),L={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/config/KaysonTenantAutoConfiguration.java",target:"_blank",rel:"noopener noreferrer"},M=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Redis</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Primary</span> <span class="token comment">// å¼•å…¥ç§Ÿæˆ·æ—¶ï¼ŒtenantRedisCacheManager ä¸ºä¸» Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">tenantRedisCacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">,</span>
                                                 <span class="token class-name">RedisCacheConfiguration</span> redisCacheConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»º RedisCacheWriter å¯¹è±¡</span>
    <span class="token class-name">RedisConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">getConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisCacheWriter</span> cacheWriter <span class="token operator">=</span> <span class="token class-name">RedisCacheWriter</span><span class="token punctuation">.</span><span class="token function">nonLockingRedisCacheWriter</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»º TenantRedisCacheManager å¯¹è±¡</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TenantRedisCacheManager</span><span class="token punctuation">(</span>cacheWriter<span class="token punctuation">,</span> redisCacheConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong></p><p>åœ¨æ–¹æ³•ä¸Šæ·»åŠ  Spring Cache æ³¨è§£ï¼Œä¾‹å¦‚è¯´ <code>@Cachable</code>ã€<code>@CachePut</code>ã€<code>@CacheEvict</code>ã€‚</p><p>æ³¨æ„ï¼ï¼ï¼é»˜è®¤é…ç½®ä¸‹ï¼ŒSpring Cache éƒ½å¼€å¯ Redis Key çš„å¤šç§Ÿæˆ·éš”ç¦»ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥å°† Key æ·»åŠ åˆ° <code>kayson.tenant.ignore-cache</code> é…ç½®é¡¹ä¸­ã€‚</p><h3 id="_5-6-aop" tabindex="-1"><a class="header-anchor" href="#_5-6-aop" aria-hidden="true">#</a> 5.6 AOP</h3><p>å®šä¹‰TenantIgnoreæ³¨è§£</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¿½ç•¥ç§Ÿæˆ·ï¼Œæ ‡è®°æŒ‡å®šæ–¹æ³•ä¸è¿›è¡Œç§Ÿæˆ·çš„è‡ªåŠ¨è¿‡æ»¤
 *
 * æ³¨æ„ï¼Œåªæœ‰ DB çš„åœºæ™¯ä¼šè¿‡æ»¤ï¼Œå…¶å®ƒåœºæ™¯æš‚æ—¶ä¸è¿‡æ»¤ï¼š
 * 1ã€Redis åœºæ™¯ï¼šå› ä¸ºæ˜¯åŸºäº Key å®ç°å¤šç§Ÿæˆ·çš„èƒ½åŠ›ï¼Œæ‰€ä»¥å¿½ç•¥æ²¡æœ‰æ„ä¹‰ï¼Œä¸åƒ DB æ˜¯ä¸€ä¸ª column å®ç°çš„
 * 2ã€MQ åœºæ™¯ï¼šæœ‰ç‚¹éš¾ä»¥æŠ‰æ‹©ï¼Œç›®å‰å¯ä»¥é€šè¿‡ Consumer æ‰‹åŠ¨åœ¨æ¶ˆè´¹çš„æ–¹æ³•ä¸Šï¼Œæ·»åŠ  @TenantIgnore è¿›è¡Œå¿½ç•¥
 *
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">TenantIgnore</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantIgnoreAspect</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(tenantIgnore)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">TenantIgnore</span> tenantIgnore<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> oldIgnore <span class="token operator">=</span> <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">isIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">setIgnore</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‰§è¡Œé€»è¾‘</span>
            <span class="token keyword">return</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">TenantContextHolder</span><span class="token punctuation">.</span><span class="token function">setIgnore</span><span class="token punctuation">(</span>oldIgnore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘  å£°æ˜ <code>@TenantIgnore</code> æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œæ ‡è®°æŒ‡å®šæ–¹æ³•ä¸è¿›è¡Œç§Ÿæˆ·çš„è‡ªåŠ¨è¿‡æ»¤ï¼Œé¿å…<strong>è‡ªåŠ¨</strong>æ‹¼æ¥ <code>WHERE tenant_id = ?</code> æ¡ä»¶ç­‰ç­‰ã€‚</p>`,9),N={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-module-system/kayson-module-system-biz/src/main/java/cn/zjh/kayson/module/system/service/permission/RoleServiceImpl.java",target:"_blank",rel:"noopener noreferrer"},q=s("code",null,"#initLocalCache()",-1),H=s("strong",null,"æ‰€æœ‰",-1),O=s("code",null,"@TenantIgnore",-1),A=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// RoleServiceImpl.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RoleService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token annotation punctuation">@Lazy</span> <span class="token comment">// æ³¨å…¥è‡ªå·±ï¼Œæ‰€ä»¥å»¶è¿ŸåŠ è½½</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> self<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token annotation punctuation">@TenantIgnore</span> <span class="token comment">// å¿½ç•¥è‡ªåŠ¨å¤šç§Ÿæˆ·ï¼Œå…¨å±€åˆå§‹åŒ–ç¼“å­˜</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... ä»æ•°æ®åº“ä¸­ï¼ŒåŠ è½½è§’è‰²</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token constant">SCHEDULER_PERIOD</span><span class="token punctuation">,</span> initialDelay <span class="token operator">=</span> <span class="token constant">SCHEDULER_PERIOD</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulePeriodicRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;x&gt; é€šè¿‡ self å¼•ç”¨åˆ° Spring ä»£ç†å¯¹è±¡</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰ä¸€ç‚¹è¦æ ¼å¤–æ³¨æ„ï¼Œç”±äº <code>@TenantIgnore</code> æ³¨è§£æ˜¯åŸºäº Spring AOP å®ç°ï¼Œå¦‚æœæ˜¯<strong>æ–¹æ³•å†…éƒ¨çš„è°ƒç”¨</strong>ï¼Œé¿å…ä½¿ç”¨ <code>this</code> å¯¼è‡´ä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é‡‡ç”¨ä¸Šè¿°ç¤ºä¾‹çš„ <code>&lt;x&gt;</code> å¤„çš„ <code>self</code> æ–¹å¼ã€‚</p>`,2),P={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/core/util/TenantUtils.java",target:"_blank",rel:"noopener noreferrer"},z=s("code",null,"#execute(Long tenantId, Runnable runnable)",-1),D=s("code",null,"tenantId",-1),B=s("code",null,"runnable",-1),F={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-module-system/kayson-module-system-biz/src/main/java/cn/zjh/kayson/module/system/service/tenant/TenantServiceImpl.java",target:"_blank",rel:"noopener noreferrer"},W=s("code",null,"#createTenant(...)",-1),K=s("p",null,[s("img",{src:k,alt:"Snipaste_2023-06-13_15-34-14"})],-1),G=s("h3",{id:"_5-7-job",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_5-7-job","aria-hidden":"true"},"#"),n(" 5.7 Job")],-1),Q={href:"https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/core/job",target:"_blank",rel:"noopener noreferrer"},J=s("code",null,"@TenantJob",-1),V=s("strong",null,"å¹¶è¡Œ",-1),Y=s("h3",{id:"_5-8-mq",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_5-8-mq","aria-hidden":"true"},"#"),n(" 5.8 MQ")],-1),X={href:"https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-biz-tenant/src/main/java/cn/zjh/kayson/framework/tenant/core/mq",target:"_blank",rel:"noopener noreferrer"},Z=s("p",null,"é€šè¿‡ç§Ÿæˆ·å¯¹ MQ å±‚é¢çš„å°è£…ï¼Œå®ç°ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç»§ç»­ä¼ é€’åˆ° MQ æ¶ˆè´¹çš„é€»è¾‘ä¸­ï¼Œé¿å…ä¸¢å¤±çš„é—®é¢˜ã€‚å®ç°åŸç†æ˜¯ï¼š",-1),$=s("ul",null,[s("li",null,[n("å‘é€æ¶ˆæ¯æ—¶ï¼ŒMQ ä¼šå°†ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„ç§Ÿæˆ·ç¼–å·ï¼Œè®°å½•åˆ° Message æ¶ˆæ¯å¤´ "),s("code",null,"tenant-id"),n(" ä¸Šã€‚")]),s("li",null,[n("æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼ŒMQ ä¼šå°† Message æ¶ˆæ¯å¤´ "),s("code",null,"tenant-id"),n("ï¼Œè®¾ç½®åˆ°ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„ç§Ÿæˆ·ç¼–å·ã€‚")])],-1),nn=s("h3",{id:"_5-9-async",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_5-9-async","aria-hidden":"true"},"#"),n(" 5.9 Async")],-1),sn={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-job/src/main/java/cn/zjh/kayson/framework/quartz/config/KaysonAsyncAutoConfiguration.java",target:"_blank",rel:"noopener noreferrer"},an=s("p",null,"ç¬¬ä¸€æ­¥ï¼ŒTenantContextHolder ä½¿ç”¨ TransmittableThreadLocalã€‚",-1),en=s("p",null,"ç¬¬äºŒæ­¥ï¼Œå°† Runnable åŒ…è£…æˆ TtlRunnable",-1),tn={href:"https://github.com/alibaba/transmittable-thread-local",target:"_blank",rel:"noopener noreferrer"},pn=t(`<h2 id="_6-å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#_6-å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½" aria-hidden="true">#</a> 6.å¤šç§Ÿæˆ·çš„ä¸šåŠ¡åŠŸèƒ½</h2><h3 id="_6-1å¤šç§Ÿæˆ·çš„ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_6-1å¤šç§Ÿæˆ·çš„ç®¡ç†" aria-hidden="true">#</a> 6.1å¤šç§Ÿæˆ·çš„ç®¡ç†</h3><p>èœå•ï¼šç³»ç»Ÿç®¡ç† -&gt; ç§Ÿæˆ·ç®¡ç† -&gt; ç§Ÿæˆ·åˆ—è¡¨</p><p>è¡¨ç»“æ„ system_tenant</p><ul><li><p>contact_user_id</p><ul><li>æŒ‡å‘ AdminUserDO</li><li>æ‹¥æœ‰è§’è‰²ï¼šç§Ÿæˆ·ç®¡ç†å‘˜(code = tenant_admin)</li></ul></li><li><p>æœ‰æ•ˆæ€§ï¼šstatusã€expireTime</p></li><li><p>é…é¢</p><ul><li>package_id</li><li>accountCount</li></ul></li></ul><p>ä»£ç å®ç°</p><ul><li>å‰ç«¯ï¼š/views/system/tenant/index.vue</li><li>åç«¯ï¼šTenantController =&gt; TenantService =&gt; TenantMapper = &gt; TenantDO</li></ul><p>å…³é”®åŠŸèƒ½</p><ul><li>åˆ›å»ºç§Ÿæˆ· <ul><li>åˆå§‹åŒ–ç§Ÿæˆ· Role ä»¥æƒé™</li><li>åˆå§‹åŒ–ç§Ÿæˆ· AdminUser</li></ul></li><li>æ›´æ–°ç§Ÿæˆ·ï¼šæ›´æ–°ç§Ÿæˆ· Role çš„æƒé™</li></ul><p>TenantInfoHandler</p><ul><li>ç›®çš„ï¼šå‡å°‘å¤šç§Ÿæˆ·çš„é€»è¾‘è€¦åˆï¼ˆå¼€å…³ã€ä¸Šä¸‹æ–‡ï¼‰ï¼Œä¸“æ³¨å®Œæˆè‡ªåŠ¨ä»¥çš„é€»è¾‘</li><li>æ¡ˆä¾‹ï¼šåˆ›å»ºç”¨æˆ·æ—¶ï¼Œè¶…è¿‡æœ€å¤§è´¦æˆ·é…é¢</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç§Ÿæˆ·ä¿¡æ¯å¤„ç†
 * ç›®çš„ï¼šå°½é‡å‡å°‘ç§Ÿæˆ·é€»è¾‘è€¦åˆåˆ°ç³»ç»Ÿä¸­
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TenantInfoHandler</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * åŸºäºä¼ å…¥çš„ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¿›è¡Œç›¸å…³é€»è¾‘çš„æ‰§è¡Œ
     * ä¾‹å¦‚è¯´ï¼Œåˆ›å»ºç”¨æˆ·æ—¶ï¼Œè¶…è¿‡æœ€å¤§è´¦æˆ·é…é¢
     *
     * <span class="token keyword">@param</span> <span class="token parameter">tenant</span> ç§Ÿæˆ·ä¿¡æ¯
     */</span>
    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">TenantDO</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2å¤šç§Ÿæˆ·çš„å¥—é¤" tabindex="-1"><a class="header-anchor" href="#_6-2å¤šç§Ÿæˆ·çš„å¥—é¤" aria-hidden="true">#</a> 6.2å¤šç§Ÿæˆ·çš„å¥—é¤</h3><p>èœå•ï¼šç³»ç»Ÿç®¡ç† -&gt; ç§Ÿæˆ·ç®¡ç† -&gt; ç§Ÿæˆ·å¥—é¤</p><p>è¡¨ç»“æ„ system_tenant_package</p><ul><li>èœå•ç¼–å·æ•°ç»„ menuIds</li></ul><p>ä»£ç å®ç°</p><ul><li>å‰ç«¯ï¼š/views/system/tenantPackage/index.vue</li><li>åç«¯ï¼šTenantPackageController =&gt; TenantPackageService =&gt; TenantPackageMapper = &gt; TenantPackageDO</li></ul><p>å…³é”®åŠŸèƒ½ - å¦‚ä½•å°†ç§Ÿæˆ·çš„å¥—é¤ï¼ŒåŒæ­¥åˆ°å¯¹åº”çš„è§’è‰²æƒé™</p><ul><li>åœºæ™¯ä¸€ï¼šåˆ›å»ºç§Ÿæˆ·æ—¶çš„åŒæ­¥</li><li>åœºæ™¯äºŒï¼šæ›´æ–°ç§Ÿæˆ·å¥—é¤æ—¶çš„åŒæ­¥</li><li>åœºæ™¯ä¸‰ï¼šæ›´æ–°ç§Ÿæˆ·å¥—é¤çš„èœå•æ—¶çš„åŒæ­¥</li></ul><p>TenantMenuHandler</p><ul><li>ç›®çš„ï¼šå‡å°‘å¤šç§Ÿæˆ·çš„é€»è¾‘è€¦åˆï¼ˆå¼€å…³ã€ä¸Šä¸‹æ–‡ï¼‰ï¼Œä¸“æ³¨å®Œæˆè‡ªåŠ¨ä»¥çš„é€»è¾‘</li><li>æ¡ˆä¾‹ï¼šåˆ†é…è§’è‰²èœå•æ—¶ï¼Œè¿‡æ»¤æ‰éç§Ÿæˆ·å¥—é¤çš„èœå•</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç§Ÿæˆ·èœå•å¤„ç†
 * ç›®çš„ï¼šå°½é‡å‡å°‘ç§Ÿæˆ·é€»è¾‘è€¦åˆåˆ°ç³»ç»Ÿä¸­
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TenantMenuHandler</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * åŸºäºä¼ å…¥çš„ç§Ÿæˆ·èœå•ã€å…¨ã€‘åˆ—è¡¨ï¼Œè¿›è¡Œç›¸å…³é€»è¾‘çš„æ‰§è¡Œ
     * ä¾‹å¦‚è¯´ï¼Œè¿”å›å¯åˆ†é…èœå•çš„æ—¶å€™ï¼Œå¯ä»¥ç§»é™¤å¤šä½™çš„
     *
     * <span class="token keyword">@param</span> <span class="token parameter">menuIds</span> èœå•åˆ—è¡¨
     */</span>
    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> menuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,23);function on(cn,ln){const a=o("ExternalLinkIcon");return c(),l("div",null,[m,b,h,s("p",null,[n("ä¾‹å¦‚è¯´ï¼Œåœ¨æœåŠ¡ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª "),s("a",g,[n("kayson"),e(a)]),n(" ç³»ç»Ÿï¼Œå¯ä»¥æ”¯æŒå¤šä¸ªä¸åŒçš„å…¬å¸ä½¿ç”¨ã€‚è¿™é‡Œçš„"),y,n("ï¼Œæ¯ä¸ªç”¨æˆ·å¿…ç„¶å±äºæŸä¸ªç§Ÿæˆ·ã€‚å› æ­¤ï¼Œç”¨æˆ·ä¹Ÿåªèƒ½çœ‹è§è‡ªå·±ç§Ÿæˆ·ä¸‹é¢çš„å†…å®¹ï¼Œå…¶å®ƒç§Ÿæˆ·çš„å†…å®¹å¯¹ä»–æ˜¯ä¸å¯è§çš„ã€‚")]),f,s("p",null,[n("æŠ€æœ¯ç»„ä»¶ "),s("a",w,[n("kayson-spring-boot-starter-biz-tenant"),e(a)]),n(" ï¼Œå®ç°é€æ˜åŒ–çš„å¤šç§Ÿæˆ·èƒ½åŠ›ï¼Œé’ˆå¯¹ Webã€Securityã€DBã€Redisã€AOPã€Jobã€MQã€Async ç­‰å¤šä¸ªå±‚é¢è¿›è¡Œå°è£…ã€‚")]),_,s("p",null,[s("a",T,[n("TenantContextHolder"),e(a)]),n(" æ˜¯ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œé€šè¿‡ ThreadLocal å®ç°ç§Ÿæˆ·ç¼–å·çš„å…±äº«ä¸ä¼ é€’ã€‚")]),I,s("p",null,[n("COLUMN æ¨¡å¼ï¼ŒåŸºäº MyBatis Plus è‡ªå¸¦çš„"),s("a",C,[n("å¤šç§Ÿæˆ· "),e(a)]),n("åŠŸèƒ½å®ç°ã€‚")]),R,s("p",null,[n("å¹¶ä¸”è¯¥è¡¨å¯¹åº”çš„ DO éœ€è¦ä½¿ç”¨åˆ° "),j,n(" å±æ€§æ—¶ï¼Œå»ºè®®ç»§æ‰¿ "),s("a",x,[n("TenantBaseDO"),e(a)]),n(" ç±»ã€‚")]),S,s("p",null,[n("åœ¨ "),s("a",E,[n("KaysonTenantAutoConfiguration"),e(a)]),n(" è‡ªåŠ¨é…ç½®ä¸­æ³¨å†Œå¤šç§Ÿæˆ·æ’ä»¶ TenantLineInnerInterceptor Beanå¯¹è±¡ã€‚")]),U,s("p",null,[n("åœ¨ "),s("a",L,[n("KaysonTenantAutoConfiguration"),e(a)]),n(" è‡ªåŠ¨é…ç½®ä¸­æ³¨å†ŒtenantRedisCacheManager ä¸ºä¸» Beanã€‚")]),M,s("p",null,[n("ä¾‹å¦‚è¯´ï¼š"),s("a",N,[n("RoleServiceImpl"),e(a)]),n(" çš„ "),q,n("æ–¹æ³•ï¼ŒåŠ è½½"),H,n("ç§Ÿæˆ·çš„è§’è‰²åˆ°å†…å­˜è¿›è¡Œç¼“å­˜ï¼Œå¦‚æœä¸å£°æ˜ "),O,n(" æ³¨è§£ï¼Œä¼šå¯¼è‡´ç§Ÿæˆ·çš„è‡ªåŠ¨è¿‡æ»¤ï¼ŒåªåŠ è½½äº†æŸä¸ªç§Ÿæˆ·çš„è§’è‰²ã€‚")]),A,s("p",null,[n("â‘¡ ä½¿ç”¨ "),s("a",P,[n("TenantUtils"),e(a)]),n(" çš„ "),z,n(" æ–¹æ³•ï¼Œæ¨¡æ‹ŸæŒ‡å®šç§Ÿæˆ·( "),D,n(" )ï¼Œæ‰§è¡ŒæŸæ®µä¸šåŠ¡é€»è¾‘( "),B,n(" )ã€‚")]),s("p",null,[n("ä¾‹å¦‚è¯´ï¼šåœ¨ "),s("a",F,[n("TenantServiceImpl"),e(a)]),n(" çš„ "),W,n(" æ–¹æ³•ï¼Œåœ¨åˆ›å»ºå®Œç§Ÿæˆ·æ—¶ï¼Œéœ€è¦æ¨¡æ‹Ÿè¯¥ç§Ÿæˆ·ï¼Œè¿›è¡Œç”¨æˆ·å’Œè§’è‰²çš„åˆ›å»ºã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š")]),K,G,s("p",null,[n("å®ç°å¯è§ "),s("a",Q,[n("job"),e(a)]),n(" åŒ…ã€‚å£°æ˜ "),J,n("æ³¨è§£åœ¨ Job ç±»ä¸Šï¼Œå®ç°"),V,n("éå†æ¯ä¸ªç§Ÿæˆ·ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„é€»è¾‘ã€‚")]),Y,s("p",null,[n("å®ç°å¯è§ "),s("a",X,[n("mq"),e(a)]),n(" åŒ…ã€‚")]),Z,$,nn,s("p",null,[n("å®ç°å¯è§ "),s("a",sn,[n("KaysonAsyncAutoConfiguration"),e(a)]),n(" ç±»ã€‚")]),an,en,s("p",null,[n("é€šè¿‡ä½¿ç”¨é˜¿é‡Œå¼€æºçš„ "),s("a",tn,[n("TransmittableThreadLocal "),e(a)]),n("ç»„ä»¶ï¼Œå®ç° Spring Async æ‰§è¡Œå¼‚æ­¥é€»è¾‘æ—¶ï¼Œç§Ÿæˆ·ä¸Šä¸‹æ–‡å¯ä»¥ç»§ç»­ä¼ é€’ï¼Œé¿å…ä¸¢å¤±çš„é—®é¢˜ã€‚")]),pn])}const rn=p(v,[["render",on],["__file","SaaSå¤šç§Ÿæˆ·.html.vue"]]);export{rn as default};
