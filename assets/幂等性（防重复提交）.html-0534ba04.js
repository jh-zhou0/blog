import{_ as p,r as o,o as c,c as i,a as s,d as n,b as e,e as t}from"./app-66d6b4fd.js";const l={},u=s("h1",{id:"å¹‚ç­‰æ€§-é˜²é‡å¤æäº¤",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#å¹‚ç­‰æ€§-é˜²é‡å¤æäº¤","aria-hidden":"true"},"#"),n(" å¹‚ç­‰æ€§ï¼ˆé˜²é‡å¤æäº¤ï¼‰")],-1),k={href:"https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-protection",target:"_blank",rel:"noopener noreferrer"},r={href:"https://gitee.com/jhzhou/kayson/tree/master/kayson-framework/kayson-spring-boot-starter-protection/src/main/java/cn/zjh/kayson/framework/idempotent",target:"_blank",rel:"noopener noreferrer"},d=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// UserController.java</span>

<span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> timeUnit <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;æ­£åœ¨æ·»åŠ ç”¨æˆ·ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/create&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    userService<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;æ·»åŠ æˆåŠŸ&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#_1-å®ç°åŸç†" aria-hidden="true">#</a> 1. å®ç°åŸç†</h2><p>å¹‚ç­‰ç»„ä»¶ï¼Œå‚è€ƒ https://github.com/it4alla/idempotent é¡¹ç›®å®ç°ã€‚</p><p>å®ƒçš„å®ç°åŸç†éå¸¸ç®€å•ï¼Œé’ˆå¯¹ç›¸åŒå‚æ•°çš„æ–¹æ³•ï¼Œä¸€æ®µæ—¶é—´å†…ï¼Œæœ‰ä¸”ä»…èƒ½æ‰§è¡Œä¸€æ¬¡ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><p>â‘  åœ¨æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ ¹æ®å‚æ•°å¯¹åº”çš„ Key æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ã€‚</p><ul><li>å¦‚æœ<strong>å­˜åœ¨</strong>ï¼Œè¯´æ˜æ­£åœ¨æ‰§è¡Œä¸­ï¼Œåˆ™è¿›è¡ŒæŠ¥é”™ã€‚</li><li>å¦‚æœ<strong>ä¸åœ¨</strong>ï¼Œåˆ™è®¡ç®—å‚æ•°å¯¹åº”çš„ Keyï¼Œå­˜å‚¨åˆ° Redis ä¸­ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå³æ ‡è®°æ­£åœ¨æ‰§è¡Œä¸­ã€‚</li></ul>`,6),m={href:"https://gitee.com/jhzhou/kayson/blob/master/kayson-framework/kayson-spring-boot-starter-protection/src/main/java/cn/zjh/kayson/framework/idempotent/core/keyresolver/impl/DefaultIdempotentKeyResolver.java",target:"_blank",rel:"noopener noreferrer"},v=t(`<p>â‘¡ æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œ<strong>ä¸ä¼š</strong>ä¸»åŠ¨åˆ é™¤å‚æ•°å¯¹åº”çš„ Keyã€‚</p><p>ğŸ™‚ ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œ<code>idempotent</code> åŒ…æä¾›çš„å¹‚ç­‰ç‰¹æ€§ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäº Redis å®ç°çš„åˆ†å¸ƒå¼é”ã€‚</p><p>â‘¢ å¦‚æœæ–¹æ³•æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡ Key çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™ Redis ä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„ Keyã€‚å› æ­¤ï¼Œéœ€è¦å¤§æ¦‚è¯„ä¼°ä¸‹ï¼Œé¿å…æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡è¿‡æœŸæ—¶é—´ã€‚</p><h2 id="_2-idempotentkeyresolveræ¥å£" tabindex="-1"><a class="header-anchor" href="#_2-idempotentkeyresolveræ¥å£" aria-hidden="true">#</a> 2.IdempotentKeyResolveræ¥å£</h2><p>å¹‚ç­‰ Key è§£æå™¨æ¥å£ IdempotentKeyResolverï¼Œå®šä¹‰è§£æ Key çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¹‚ç­‰ Key è§£æå™¨æ¥å£
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IdempotentKeyResolver</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * è§£æä¸€ä¸ª Key
     *
     * <span class="token keyword">@param</span> <span class="token parameter">joinPoint</span>  AOP åˆ‡é¢
     * <span class="token keyword">@param</span> <span class="token parameter">idempotent</span> å¹‚ç­‰æ³¨è§£
     * <span class="token keyword">@return</span> Key
     */</span>
    <span class="token class-name">String</span> <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é»˜è®¤çš„ Key è§£æå™¨å®ç°ï¼šDefaultIdempotentKeyResolverï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * é»˜è®¤å¹‚ç­‰ Key è§£æå™¨ï¼Œä½¿ç”¨æ–¹æ³•å + æ–¹æ³•å‚æ•°ï¼Œç»„è£…æˆä¸€ä¸ª Key
 * 
 * ä¸ºäº†é¿å… Key è¿‡é•¿ï¼Œä½¿ç”¨ MD5 è¿›è¡Œâ€œå‹ç¼©â€
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultIdempotentKeyResolver</span> <span class="token keyword">implements</span> <span class="token class-name">IdempotentKeyResolver</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> argsStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">SecureUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>methodName <span class="token operator">+</span> argsStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åŸºäº Spring EL è¡¨è¾¾å¼çš„ Key è§£æå™¨å®ç°ï¼šExpressionIdempotentKeyResolverï¼Œé€šè¿‡è§£ææ³¨è§£ @Idempotent çš„ keyArg() ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åŸºäº Spring EL è¡¨è¾¾å¼
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExpressionIdempotentKeyResolver</span> <span class="token keyword">implements</span> <span class="token class-name">IdempotentKeyResolver</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ParameterNameDiscoverer</span> parameterNameDiscoverer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalVariableTableParameterNameDiscoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExpressionParser</span> expressionParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å¾—è¢«æ‹¦æˆªæ–¹æ³•å‚æ•°ååˆ—è¡¨</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token function">getMethod</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterNameDiscoverer<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‡†å¤‡ Spring EL è¡¨è¾¾å¼è§£æçš„ä¸Šä¸‹æ–‡</span>
        <span class="token class-name">StandardEvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>parameterNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parameterNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                evaluationContext<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span>parameterNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è§£æå‚æ•°</span>
        <span class="token class-name">Expression</span> expression <span class="token operator">=</span> expressionParser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">keyArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> point<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¤„ç†ï¼Œå£°æ˜åœ¨ç±»ä¸Šçš„æƒ…å†µ</span>
        <span class="token class-name">MethodSignature</span> signature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> method<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¤„ç†ï¼Œå£°æ˜åœ¨æ¥å£ä¸Šçš„æƒ…å†µ</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> point<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>
                    point<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-idempotentæ³¨è§£" tabindex="-1"><a class="header-anchor" href="#_3-idempotentæ³¨è§£" aria-hidden="true">#</a> 3. @Idempotentæ³¨è§£</h2><p>@Idempotent æ³¨è§£ï¼Œå£°æ˜åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦å¼€å¯å¹‚ç­‰æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¹‚ç­‰æ³¨è§£
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Idempotent</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/**
     * å¹‚ç­‰çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 1 ç§’
     *
     * æ³¨æ„ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´è¶…è¿‡å®ƒï¼Œè¯·æ±‚è¿˜æ˜¯ä¼šè¿›æ¥
     */</span>
    <span class="token keyword">int</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * æ—¶é—´å•ä½ï¼Œé»˜è®¤ä¸º SECONDS ç§’
     */</span>
    <span class="token class-name">TimeUnit</span> <span class="token function">timeUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æç¤ºä¿¡æ¯ï¼Œæ­£åœ¨æ‰§è¡Œä¸­çš„æç¤º
     */</span>
    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ä½¿ç”¨çš„ Key è§£æå™¨
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IdempotentKeyResolver</span><span class="token punctuation">&gt;</span></span> <span class="token function">keyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">DefaultIdempotentKeyResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * ä½¿ç”¨çš„ Key å‚æ•°
     */</span>
    <span class="token class-name">String</span> <span class="token function">keyArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-aopåˆ‡é¢-idempotentaspect-ç±»" tabindex="-1"><a class="header-anchor" href="#_4-aopåˆ‡é¢-idempotentaspect-ç±»" aria-hidden="true">#</a> 4.AOPåˆ‡é¢ IdempotentAspect ç±»</h2><p>@Idempotent å¯¹åº”çš„ AOP åˆ‡é¢æ˜¯ IdempotentAspect ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ‹¦æˆªå£°æ˜äº† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Idempotent</span></span><span class="token punctuation">}</span> æ³¨è§£çš„æ–¹æ³•ï¼Œå®ç°å¹‚ç­‰æ“ä½œ
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAspect</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IdempotentKeyResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">IdempotentKeyResolver</span><span class="token punctuation">&gt;</span></span> keyResolvers<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IdempotentRedisDAO</span> idempotentRedisDAO<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">IdempotentAspect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IdempotentKeyResolver</span><span class="token punctuation">&gt;</span></span> keyResolvers<span class="token punctuation">,</span> <span class="token class-name">IdempotentRedisDAO</span> idempotentRedisDAO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyResolvers <span class="token operator">=</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">convertMap</span><span class="token punctuation">(</span>keyResolvers<span class="token punctuation">,</span> <span class="token class-name">IdempotentKeyResolver</span><span class="token operator">::</span><span class="token function">getClass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>idempotentRedisDAO <span class="token operator">=</span> idempotentRedisDAO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(idempotent)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforePointCut</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å¾— IdempotentKeyResolver</span>
        <span class="token class-name">IdempotentKeyResolver</span> keyResolver <span class="token operator">=</span> keyResolvers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">keyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è§£æ key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyResolver<span class="token punctuation">.</span><span class="token function">resolver</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// é”å®š key</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> idempotentRedisDAO<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">timeUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é”å®šå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[beforePointCut][æ–¹æ³•({}) å‚æ•°({}) å­˜åœ¨é‡å¤è¯·æ±‚]&quot;</span><span class="token punctuation">,</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">GlobalErrorCodeConstants</span><span class="token punctuation">.</span><span class="token constant">REPEATED_REQUESTS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-idempotentredisdao" tabindex="-1"><a class="header-anchor" href="#_5-idempotentredisdao" aria-hidden="true">#</a> 5.IdempotentRedisDAO</h2><p>å¹‚ç­‰ Redis DAOï¼Œç”¨äºæ“ä½œRedisï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¹‚ç­‰ Redis DAO
 * 
 * <span class="token keyword">@author</span> zjh - kayson
 */</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentRedisDAO</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RedisKeyDefine</span> <span class="token constant">IDEMPOTENT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisKeyDefine</span><span class="token punctuation">(</span><span class="token string">&quot;å¹‚ç­‰æ“ä½œ&quot;</span><span class="token punctuation">,</span> 
            <span class="token string">&quot;idempotent:%s&quot;</span><span class="token punctuation">,</span> <span class="token comment">// å‚æ•°ä¸º uuid</span>
            <span class="token class-name">RedisKeyDefine<span class="token punctuation">.</span>KeyTypeEnum</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
            <span class="token class-name">RedisKeyDefine<span class="token punctuation">.</span>TimeoutTypeEnum</span><span class="token punctuation">.</span><span class="token constant">DYNAMIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">IDEMPOTENT</span><span class="token punctuation">.</span><span class="token function">getKeyTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19);function b(y,g){const a=o("ExternalLinkIcon");return c(),i("div",null,[u,s("p",null,[s("a",k,[n("kayson-spring-boot-starter-protection"),e(a)]),n(" æŠ€æœ¯ç»„ä»¶ï¼Œç”±å®ƒçš„ "),s("a",r,[n("idempotent"),e(a)]),n(" åŒ…ï¼Œæä¾›å£°æ˜å¼çš„å¹‚ç­‰ç‰¹æ€§ï¼Œå¯é˜²æ­¢é‡å¤è¯·æ±‚ã€‚ä¾‹å¦‚è¯´ï¼Œç”¨æˆ·å¿«é€Ÿçš„åŒå‡»äº†æŸä¸ªæŒ‰é’®ï¼Œå‰ç«¯æ²¡æœ‰ç¦ç”¨è¯¥æŒ‰é’®ï¼Œå¯¼è‡´å‘é€äº†ä¸¤æ¬¡é‡å¤çš„è¯·æ±‚ã€‚")]),d,s("p",null,[n("é»˜è®¤å‚æ•°çš„ Redis Key çš„è®¡ç®—è§„åˆ™ç”± "),s("a",m,[n("DefaultIdempotentKeyResolver"),e(a)]),n(" å®ç°ï¼Œä½¿ç”¨ MD5(æ–¹æ³•å + æ–¹æ³•å‚æ•°)ï¼Œé¿å… Redis Key è¿‡é•¿ã€‚")]),v])}const h=p(l,[["render",b],["__file","å¹‚ç­‰æ€§ï¼ˆé˜²é‡å¤æäº¤ï¼‰.html.vue"]]);export{h as default};
